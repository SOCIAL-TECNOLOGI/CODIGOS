<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taxonom√≠a de Bloom ‚Äì M√≥vil (Tap-to-Place)</title>
<style>
  :root{
    --bg:#0b1022; --panel:#111827; --borde:#1f2937; --txt:#e5e7eb; --muted:#9ca3af;
    --green:#22c55e; --yellow:#f59e0b; --red:#ef4444; --blue:#22d3ee; --vio:#a78bfa;
    --saber:#38bdf8; --hacer:#fb923c; --ser:#34d399;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
    color:var(--txt); background:radial-gradient(1200px 800px at 70% -20%, #1f2937, #0b1022) fixed;
    -webkit-tap-highlight-color: transparent;
  }
  header{padding:16px 16px 8px}
  h1{margin:0 0 6px; font-size:20px}
  .sub{margin:0; color:var(--muted); font-size:13px}

  .wrap{display:grid; gap:12px; grid-template-columns:1fr; padding:0 12px 18px}

  .panel{background:rgba(17,24,39,.7); border:1px solid var(--borde); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px)}
  .top{display:grid; gap:10px; padding:12px}
  .hud{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .chip{padding:6px 10px; border:1px solid #334155; border-radius:999px; background:#0b1224; color:#e5e7eb; font-weight:800; font-size:13px}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  button{border:1px solid var(--borde); background:#0b1224; color:#e5e7eb; cursor:pointer; padding:10px 12px; border-radius:10px; font-weight:800; width:100%}
  .row{display:flex; gap:8px; align-items:center}
  .row > * {flex:1}
  input, select{background:#0b1224; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px; width:100%}
  .toggle{display:flex; align-items:center; gap:8px; color:#e5e7eb; font-weight:700}
  .toggle input{width:auto}

  /* Etiquetas de dimensi√≥n */
  .dim-head{display:flex; justify-content:space-between; align-items:center; padding:12px}
  .dim-title{font-weight:900}
  .tag{padding:.25rem .6rem; border-radius:999px; font-size:.8rem; font-weight:800; border:1px solid #334155}
  .tag.saber{color:#dff6ff; background:linear-gradient(90deg, rgba(56,189,248,.18), transparent)}
  .tag.hacer{color:#fff3e6; background:linear-gradient(90deg, rgba(251,146,60,.18), transparent)}
  .tag.ser{color:#eafff5; background:linear-gradient(90deg, rgba(52,211,153,.18), transparent)}

  /* Banco */
  .bank{padding:12px}
  .bank h3{margin:0 0 10px; font-size:16px}
  .bank-grid{display:flex; flex-direction:column; gap:10px}
  .card{
    --bgc:#0e162a;
    display:flex; align-items:center; justify-content:center;
    min-height:52px; padding:12px; border-radius:14px;
    border:1px solid #2a3a59; background:var(--bgc); color:#e5e7eb;
    font-weight:900; letter-spacing:.02em; font-size:18px;
    box-shadow:0 4px 12px rgba(0,0,0,.35);
    user-select:none; touch-action:manipulation;
  }
  .card[data-dim="saber"]{--bgc:rgba(56,189,248,.10); border-color:rgba(56,189,248,.35)}
  .card[data-dim="hacer"]{--bgc:rgba(251,146,60,.10);  border-color:rgba(251,146,60,.35)}
  .card[data-dim="ser"]  {--bgc:rgba(52,211,153,.10);  border-color:rgba(52,211,153,.35)}
  .card.selected{outline:3px solid var(--vio)}

  /* Niveles (pila vertical) */
  .levels{display:grid; gap:12px; padding:12px}
  .lvl{
    background:#0b1224; border:1px dashed #334155; border-radius:16px; padding:12px;
  }
  .pillbar{display:flex; gap:10px; margin-bottom:8px}
  .pill{flex:1; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900}
  .p1{background:#b91c1c}.p2{background:#d97706}.p3{background:#eab308;color:#0b1022}.p4{background:#65a30d}
  .lvl h4{margin:0 0 6px; font-size:14px; color:#cbd5e1}
  .hint{margin:6px 0 10px; color:#9ca3af; font-size:13px}
  .hint.hidden{display:none}
  .drop{display:flex; flex-direction:column; gap:8px; min-height:54px}

  /* Feedback */
  .ok{outline:2px solid #16a34a}
  .bad{animation:shake .2s linear 2}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

  /* Timer y marcador */
  .timer{font-weight:900; font-size:22px; letter-spacing:.04em}
  .timer.low{color:#ffd1d1}
  .score{font-weight:900; font-size:18px}

  /* Modal final */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:100}
  .card-modal{background:#0b1224; border:1px solid #334155; border-radius:16px; padding:22px; max-width:520px; text-align:center; margin:16px}
  .card-modal h3{margin:0 0 6px}
  .card-modal p{margin:6px 0 16px; color:#cbd5e1}
  .card-modal button{width:auto}

  /* Botoncitos de banco */
  .btns{display:flex; gap:8px; margin-top:8px}
  .btns button{flex:1}

  /* Accesibilidad t√°ctil */
  .touch-target{min-height:48px}

  /* Destello pastilla + contador */
  .pill.flash{ box-shadow:0 0 0 3px rgba(255,255,255,.25) inset; transform:translateZ(0) scale(0.98); transition:box-shadow .18s, transform .18s; }
  .lvl .count{ margin-top:6px; font-size:12px; color:#cbd5e1; opacity:.85 }
  .lvl .count.done{ color:#86efac; font-weight:700 }

  /* Opciones */
  .opt-panel{margin-top:6px; border-top:1px solid #1f2937; padding-top:8px}
  .opt-grid{display:grid; gap:8px; grid-template-columns:1fr}
  @media (min-width:520px){
    .opt-grid{grid-template-columns:1fr 1fr}
  }
  .opt-grid label{display:flex; align-items:center; gap:10px}
  .opt-grid label > span{min-width:140px; color:#cbd5e1}

  /* Desktop: ancho moderado */
  @media (min-width:720px){
    .wrap{max-width:820px; margin:0 auto}
  }
</style>
</head>
<body>
<header>
  <h1>Taxonom√≠a de Bloom ‚Äì M√≥vil</h1>
  <p class="sub">Toca una <strong>tarjeta</strong> y luego un <strong>nivel</strong>. Completa SABER ‚Üí HACER ‚Üí SER.</p>
</header>

<div class="wrap">
  <!-- Panel superior: estado + controles -->
  <section class="panel top">
    <div class="hud">
      <span class="chip">Aciertos: <strong id="ok">0</strong>/<strong id="total">0</strong></span>
      <span class="chip">Restantes: <strong id="left">0</strong></span>
      <span class="chip">Puntos: <strong id="pts">0</strong></span>
      <span class="chip" id="examBadge" style="display:none">Modo Examen</span>
    </div>

    <div class="row">
      <div class="chip" style="flex:0 0 auto">Tiempo</div>
      <div class="timer" id="timer">05:00</div>
      <input type="number" id="min" value="5" min="1" class="touch-target" style="max-width:80px">
      <input type="number" id="sec" value="0" min="0" max="59" class="touch-target" style="max-width:80px">
      <button id="start">‚ñ∂ Iniciar</button>
    </div>
    <div class="row">
      <button id="pause">‚è∏ Pausa</button>
      <button id="restart">‚Ü∫ Reiniciar tiempo</button>
    </div>

    <label class="toggle"><input type="checkbox" id="exam" /> Modo Examen (oculta pistas, -5 por error)</label>

    <div class="row">
      <button id="reshuffle">üîÄ Reorganizar verbos</button>
      <button id="reset">‚Üª Reiniciar dimensi√≥n</button>
    </div>

    <!-- PANEL DE OPCIONES -->
    <div class="opt-panel">
      <div style="color:#cbd5e1; font-weight:800; margin:6px 0 6px">Opciones</div>
      <div class="opt-grid">
        <label class="toggle"><input type="checkbox" id="optHaptics"><span>Vibraci√≥n (haptics)</span></label>
        <label class="toggle"><input type="checkbox" id="optTones"><span>Tonos por nivel</span></label>
        <label><span>Doble toque (ms)</span><input type="number" id="optDoubleTap" min="150" max="800" step="10" value="300"></label>
        <label><span>Deshacer (l√≠mite)</span><input type="number" id="optUndoLimit" min="0" max="200" value="20"></label>
      </div>
      <div class="btns" style="margin-top:8px">
        <button id="saveOptions">üíæ Guardar opciones</button>
        <button id="resetOptions">üßπ Predeterminados</button>
      </div>
      <div class="hint" style="margin-top:6px">Nota: en <strong>Modo Examen</strong> los tonos por nivel se desactivan aunque est√©n habilitados.</div>
    </div>
  </section>

  <!-- Banco -->
  <section class="panel bank">
    <div class="dim-head">
      <div class="dim-title" id="dimTitle">üìò SABER (Cognitivo)</div>
      <span id="dimTag" class="tag saber">Dimensi√≥n activa</span>
    </div>
    <div style="padding:0 12px 6px; color:var(--muted); font-size:13px">Toca una tarjeta para seleccionarla.</div>
    <div id="bank" class="bank-grid"></div>
    <div class="btns" style="padding:0 0 4px 0">
      <button id="sortAZ">üî§ Ordenar A‚ÄìZ</button>
      <button id="shuffleBank">üîÄ Desordenar</button>
    </div>
  </section>

  <!-- Niveles -->
  <section class="panel">
    <div class="levels" id="levels">
      <!-- Se crean por JS -->
    </div>
  </section>
</div>

<!-- MODAL FINAL -->
<div class="modal" id="modal">
  <div class="card-modal">
    <h3>üéâ ¬°Ronda completada!</h3>
    <p id="finalMsg">Resultados‚Ä¶</p>
    <button id="closeModal">Aceptar</button>
  </div>
</div>

<script>
/* ================== PAR√ÅMETROS (overrides por query/localStorage) ================== */
const DEFAULTS = { haptics:true, tones:true, doubleTapMs:300, undoLimit:20 };
function toBool(v){ if(v===undefined||v===null) return undefined; const s=String(v).toLowerCase(); return (s==='1'||s==='true'||s==='on'||s==='yes'); }
function sanitize(o){
  const r={};
  if(typeof o.haptics === 'boolean') r.haptics = o.haptics;
  if(typeof o.tones   === 'boolean') r.tones   = o.tones;
  if(Number.isFinite(+o.doubleTapMs) && +o.doubleTapMs>=150 && +o.doubleTapMs<=800) r.doubleTapMs = +o.doubleTapMs;
  if(Number.isFinite(+o.undoLimit)   && +o.undoLimit>=0   && +o.undoLimit<=200)     r.undoLimit   = +o.undoLimit;
  return r;
}
function loadConfig(){
  let cfg = {...DEFAULTS};
  try{
    const fromLS = JSON.parse(localStorage.getItem('bloomMobileCfg') || '{}');
    cfg = {...cfg, ...sanitize(fromLS)};
  }catch(e){}
  const qs = new URLSearchParams(location.search);
  const q = {};
  if(qs.has('haptics')) q.haptics = toBool(qs.get('haptics'));
  if(qs.has('tones'))   q.tones   = toBool(qs.get('tones'));
  if(qs.has('dbltap'))  q.doubleTapMs = parseInt(qs.get('dbltap'),10);
  if(qs.has('undo'))    q.undoLimit   = parseInt(qs.get('undo'),10);
  cfg = {...cfg, ...sanitize(q)};
  return cfg;
}
let CFG = loadConfig();
const HAPTICS     = () => CFG.haptics;
const LEVEL_TONES = () => CFG.tones;
const DBLTAP      = () => CFG.doubleTapMs;
const UNDO_LIM    = () => CFG.undoLimit;

/* ================== Datos ================== */
const DATA = {
  saber: {
    4: ["Evaluar","Argumentar","Justificar","Dise√±ar","Formular","Crear","Innovar","Planificar","Concebir","Dise√±ar Prompts"],
    3: ["Aplicar","Analizar","Comparar","Organizar","Diferenciar","Contrastar","Revisar"],
    2: ["Comprender","Describir","Explicar","Interpretar","Ejemplificar","Clasificar","Refinar"],
    1: ["Recordar","Identificar","Reconocer","Definir","Listar","Nombrar"]
  },
  hacer: {
    4: ["Automatizar","Optimizar","Transferir","Innovar","Trazar Estrategias","Combinar Herramientas"],
    3: ["Coordinar","Implementar","Integrar","Perfeccionar","Aplicar Con Autonom√≠a"],
    2: ["Ejecutar","Practicar","Demostrar","Operar","Utilizar Con Apoyo"],
    1: ["Imitar","Copiar","Seguir Instrucciones","Manipular Con Ayuda"]
  },
  ser: {
    4: ["Interiorizar","Liderar","Modelar","Transformar","Influir Positivamente","Validar √âticamente"],
    3: ["Valorar","Argumentar","Promover","Asumir Responsabilidades","Ser Consciente"],
    2: ["Responder","Participar","Colaborar","Respetar","Cumplir"],
    1: ["Atender","Escuchar","Aceptar","Mostrar Disposici√≥n"]
  }
};
const DIM_ORDER = ["saber","hacer","ser"];
const TITLE = {
  saber:"üìò SABER (Cognitivo)",
  hacer:"üõ†Ô∏è HACER (Psicomotor)",
  ser:"ü§ù SER (Afectivo/Actitudinal)"
};
const POINT_CORRECT = 10;
const PENALTY_WRONG = -5;

/* ================== DOM refs ================== */
const bankEl      = document.getElementById('bank');
const levelsEl    = document.getElementById('levels');
const okEl        = document.getElementById('ok');
const totalEl     = document.getElementById('total');
const leftEl      = document.getElementById('left');
const ptsEl       = document.getElementById('pts');
const dimTitle    = document.getElementById('dimTitle');
const dimTag      = document.getElementById('dimTag');
const examChk     = document.getElementById('exam');
const examBadge   = document.getElementById('examBadge');
const btnShuffleAll  = document.getElementById('reshuffle');
const btnReset       = document.getElementById('reset');
const btnAZ          = document.getElementById('sortAZ');
const btnShuffleBank = document.getElementById('shuffleBank');
const timerEl = document.getElementById('timer');
const minEl   = document.getElementById('min');
const secEl   = document.getElementById('sec');
const startBtn= document.getElementById('start');
const pauseBtn= document.getElementById('pause');
const restartBtn=document.getElementById('restart');
const modal   = document.getElementById('modal');
const finalMsg= document.getElementById('finalMsg');
const closeModal = document.getElementById('closeModal');
/* Opciones UI */
const optHaptics   = document.getElementById('optHaptics');
const optTones     = document.getElementById('optTones');
const optDoubleTap = document.getElementById('optDoubleTap');
const optUndoLimit = document.getElementById('optUndoLimit');
const btnSaveOpts  = document.getElementById('saveOptions');
const btnResetOpts = document.getElementById('resetOptions');

/* ================== Estado ================== */
let currentDimIndex = 0;
let currentDim = DIM_ORDER[currentDimIndex];
let CARDS = [];              // {el, verb, level, locked}
let selectedCard = null;
let points = 0;
let undoStack = [];          // [{el, verb, level}]
let lastTap = {el:null, t:0}; // para doble-tap

/* ================== Utils ================== */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}
function pad2(n){return String(n).padStart(2,'0');}

/* ====== Sonidos ====== */
let audioCtx;
function baseCtx(){ try{ audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)(); }catch(_){} return audioCtx; }
function ding(){ try{ const ctx=baseCtx(); if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='triangle'; o.frequency.value=900; g.gain.value=0.0001; o.connect(g); g.connect(ctx.destination);
  const t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.12,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22);
  o.start(); o.stop(t+0.25);}catch(e){} }
function buzz(){ try{ const ctx=baseCtx(); if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='sawtooth'; o.frequency.value=180; g.gain.value=0.0001; o.connect(g); g.connect(ctx.destination);
  const t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.12,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.38);
  o.start(); o.stop(t+0.4);}catch(e){} }
function playTone(freq=660, dur=0.18, type='triangle'){
  try{ const ctx=baseCtx(); if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=0.0001; o.connect(g); g.connect(ctx.destination);
    const t=ctx.currentTime; g.gain.exponentialRampToValueAtTime(0.12,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(); o.stop(t+dur+0.02);
  }catch(_){}
}
const LEVEL_FREQ = {1:440, 2:620, 3:820, 4:1020};
function playLevelTone(level){
  if (examChk.checked || !LEVEL_TONES()) { ding(); return; } // neutral en examen o si est√° apagado
  playTone(LEVEL_FREQ[level] || 800, 0.18, 'triangle');
}

/* ================== Construcci√≥n UI ================== */
function buildBank(){
  bankEl.innerHTML = "";
  CARDS = [];
  const list = [];
  for (const lvl of Object.keys(DATA[currentDim])){
    for (const v of DATA[currentDim][lvl]){
      list.push({verb:v, level:+lvl});
    }
  }
  shuffle(list).forEach(item=>{
    const el = document.createElement('div');
    el.className = 'card touch-target';
    el.textContent = item.verb;
    el.dataset.dim = currentDim;
    el.dataset.level = String(item.level);
    el.addEventListener('click', ()=> onCardTap(item.verb, item.level, el));
    bankEl.appendChild(el);
    CARDS.push({el, verb:item.verb, level:item.level, locked:false});
  });
  updateCounters();
}

function applyDimHeader(){
  dimTitle.textContent = TITLE[currentDim];
  dimTag.className = 'tag '+currentDim;
}

function updateCounters(){
  const ok = CARDS.filter(c=>c.locked).length;
  const total = CARDS.length;
  okEl.textContent = ok;
  totalEl.textContent = total;
  leftEl.textContent = (total-ok);
  ptsEl.textContent = points;
}

/* ====== Contadores por nivel ====== */
function updateLevelCounter(level){
  const total = DATA[currentDim][level].length;
  const placed = CARDS.filter(c=>c.locked && c.level===level).length;
  const remaining = total - placed;
  const el = document.querySelector(`.lvl[data-level="${level}"] .count`);
  if(el){
    el.textContent = `Quedan: ${remaining}/${total}`;
    el.classList.toggle('done', remaining===0);
  }
}
function updateAllLevelCounters(){ for(let lvl=1; lvl<=4; lvl++) updateLevelCounter(lvl); }

/* ================== Interacci√≥n tarjetas ================== */
function onCardTap(verb, level, el){
  const now = Date.now();
  // Doble-tap para deseleccionar
  if (selectedCard && selectedCard.el===el && (now - lastTap.t) < DBLTAP()){
    el.classList.remove('selected');
    selectedCard = null;
    lastTap = {el:null, t:0};
    return;
  }
  lastTap = {el, t:now};

  // Alternar selecci√≥n
  if(selectedCard && selectedCard.el === el){
    el.classList.remove('selected'); selectedCard = null; return;
  }
  if(selectedCard) selectedCard.el.classList.remove('selected');
  selectedCard = {verb, level, el};
  el.classList.add('selected');
  if(HAPTICS() && navigator.vibrate) navigator.vibrate(15);
}

/* ================== Tap en nivel/pastilla ================== */
function onLevelTap(targetLevel, levelBox, dropEl){
  if(!selectedCard) return;

  const correct = (selectedCard.level === targetLevel);
  levelBox.classList.remove('bad','ok'); void levelBox.offsetWidth;

  if(correct){
    // Mover al nivel
    dropEl.appendChild(selectedCard.el);
    selectedCard.el.classList.remove('selected');
    selectedCard.el.classList.add('ok');
    selectedCard.el.style.opacity = '1';

    // Bloquear en modelo
    const c = CARDS.find(x=>x.el===selectedCard.el);
    if(c){ c.locked = true; }

    // Quitar de pista y actualizar contadores
    removeFromHint(targetLevel, selectedCard.verb);
    updateLevelCounter(targetLevel);

    // Push a pila de deshacer
    undoStack.push({ el:selectedCard.el, verb:selectedCard.verb, level:targetLevel });
    if(undoStack.length > UNDO_LIM()) undoStack.shift();

    // Puntos + sonido
    points += POINT_CORRECT;
    playLevelTone(targetLevel);
    selectedCard = null;
    updateCounters();
    checkDimensionDone();
  }else{
    levelBox.classList.add('bad');
    if(HAPTICS() && navigator.vibrate) navigator.vibrate(60);
    buzz();
    if(examChk.checked){
      points += PENALTY_WRONG;
      updateCounters();
    }
  }
}

/* ====== Pistas ====== */
function removeFromHint(level, verb){
  const hintEl = document.querySelector(`.hint[data-hint="${level}"]`);
  if(!hintEl) return;
  const items = hintEl.textContent.split(',').map(s=>s.trim()).filter(Boolean);
  const idx = items.findIndex(t => t.localeCompare(verb,'es',{sensitivity:'base'})===0);
  if(idx!==-1) items.splice(idx,1);
  hintEl.textContent = items.join(', ');
  if(items.length===0) hintEl.classList.add('hidden');
}
function addBackToHint(level, verb){
  const hintEl = document.querySelector(`.hint[data-hint="${level}"]`);
  if(!hintEl) return;
  const parts = hintEl.textContent ? hintEl.textContent.split(',').map(s=>s.trim()).filter(Boolean) : [];
  parts.push(verb);
  parts.sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
  hintEl.textContent = parts.join(', ');
  hintEl.classList.remove('hidden');
}

/* ================== Flujo por dimensiones ================== */
function checkDimensionDone(){
  const done = CARDS.length>0 && CARDS.every(c=>c.locked);
  if(!done) return;
  const nextIndex = currentDimIndex + 1;
  if(nextIndex < DIM_ORDER.length){
    currentDimIndex = nextIndex;
    currentDim = DIM_ORDER[currentDimIndex];
    toast(`‚úî Dimensi√≥n completada. Siguiente: ${TITLE[currentDim]}`);
    undoStack = [];
    switchDimension(currentDim);
  }else{
    endRound();
  }
}

function switchDimension(dim){
  currentDim = dim;
  applyDimHeader();
  buildLevels();
  buildBank();
  updateAllLevelCounters();
}

/* ================== Controles banco ================== */
btnAZ.addEventListener('click', ()=>{
  const free = CARDS.filter(c=>!c.locked);
  free.sort((a,b)=> a.verb.localeCompare(b.verb,'es',{sensitivity:'base'}));
  free.forEach(c=> bankEl.appendChild(c.el));
});
btnShuffleBank.addEventListener('click', ()=>{
  const free = CARDS.filter(c=>!c.locked);
  shuffle(free);
  free.forEach(c=> bankEl.appendChild(c.el));
});
btnShuffleAll.addEventListener('click', ()=>{
  const free = CARDS.filter(c=>!c.locked);
  shuffle(free);
  free.forEach(c=> bankEl.appendChild(c.el));
});
btnReset.addEventListener('click', ()=>{
  CARDS.forEach(c=>{ c.locked=false; c.el.classList.remove('ok','selected'); bankEl.appendChild(c.el); });
  for(let lvl=1; lvl<=4; lvl++){
    const hintEl = document.querySelector(`.hint[data-hint="${lvl}"]`);
    hintEl.textContent = DATA[currentDim][lvl].join(', ');
    hintEl.classList.toggle('hidden', examChk.checked);
  }
  undoStack = [];
  selectedCard=null;
  updateAllLevelCounters();
  updateCounters();
});

/* ================== Examen ================== */
examChk.addEventListener('change', ()=>{
  examBadge.style.display = examChk.checked ? 'inline-block' : 'none';
  document.querySelectorAll('.hint').forEach(h=> h.classList.toggle('hidden', examChk.checked));
});

/* ================== Cron√≥metro ================== */
let timerId=null, timeLeft=300, running=false, finished=false;
function setTimeFromInputs(){ const m=Math.max(0,+minEl.value|0); const s=Math.max(0,Math.min(59,+secEl.value|0)); timeLeft=m*60+s; updateTimer(); }
function updateTimer(){ timerEl.textContent = `${pad2(Math.floor(timeLeft/60))}:${pad2(timeLeft%60)}`; timerEl.classList.toggle('low', timeLeft<=10); }
function startTimer(){ if(running) return; running=true; clearInterval(timerId); timerId=setInterval(()=>{ timeLeft--; updateTimer(); if(timeLeft<=0){ timeLeft=0; updateTimer(); endRound(); }},1000); }
function pauseTimer(){ running=false; clearInterval(timerId); timerId=null; }
function restartTimer(){ pauseTimer(); setTimeFromInputs(); updateTimer(); }
startBtn.addEventListener('click', ()=>{ if(!finished) startTimer(); });
pauseBtn.addEventListener('click', pauseTimer);
restartBtn.addEventListener('click', restartTimer);
minEl.addEventListener('change', ()=>{ if(!running) setTimeFromInputs(); });
secEl.addEventListener('change', ()=>{ if(!running) setTimeFromInputs(); });

/* ================== Final ================== */
function endRound(){
  if(finished) return;
  finished = true;
  pauseTimer();
  finalMsg.textContent = `Puntos: ${points} ¬∑ Tiempo restante: ${timerEl.textContent}`;
  modal.style.display='grid';
}
closeModal.addEventListener('click', ()=> {
  modal.style.display='none';
  points = 0; ptsEl.textContent = '0';
  finished=false; selectedCard=null; undoStack=[];
  currentDimIndex = 0; currentDim = DIM_ORDER[0];
  switchDimension(currentDim);
  setTimeFromInputs(); updateTimer();
});

/* ================== Toast ================== */
function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.left='50%'; t.style.bottom='24px';
  t.style.transform='translateX(-50%)';
  t.style.background='#0b1224'; t.style.border='1px solid #334155'; t.style.color='#e5e7eb';
  t.style.padding='10px 14px'; t.style.borderRadius='12px'; t.style.boxShadow='0 10px 30px rgba(0,0,0,.35)'; t.style.zIndex='200';
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .25s'; t.style.opacity='0'; }, 1200);
  setTimeout(()=>{ t.remove(); }, 1500);
}

/* ================== Opciones: UI ‚áÑ CFG ================== */
function populateOptionsUI(){
  optHaptics.checked   = !!HAPTICS();
  optTones.checked     = !!LEVEL_TONES();
  optDoubleTap.value   = DBLTAP();
  optUndoLimit.value   = UNDO_LIM();
}
function applyOptionsFromUI({save=false}={}){
  const next = {
    haptics: !!optHaptics.checked,
    tones:   !!optTones.checked,
    doubleTapMs: Math.max(150, Math.min(800, parseInt(optDoubleTap.value||300,10))),
    undoLimit:   Math.max(0,   Math.min(200, parseInt(optUndoLimit.value||20,10))),
  };
  CFG = {...CFG, ...sanitize(next)};
  // Ajustar pila de deshacer si el l√≠mite baj√≥
  if(undoStack.length > UNDO_LIM()){
    undoStack = undoStack.slice(-UNDO_LIM());
  }
  if(save){
    localStorage.setItem('bloomMobileCfg', JSON.stringify(CFG));
    toast('‚úÖ Opciones guardadas');
  }else{
    toast('‚öôÔ∏è Opciones aplicadas');
  }
}
btnSaveOpts.addEventListener('click', ()=> applyOptionsFromUI({save:true}));
btnResetOpts.addEventListener('click', ()=>{
  CFG = {...DEFAULTS};
  localStorage.setItem('bloomMobileCfg', JSON.stringify(CFG));
  populateOptionsUI();
  toast('üîÑ Opciones restablecidas');
});

/* ================== Init + delegaci√≥n ================== */
function ensureUndoButton(){
  let undoBtn = document.getElementById('undo');
  if(!undoBtn && btnReset){
    undoBtn = document.createElement('button');
    undoBtn.id = 'undo';
    undoBtn.textContent = '‚Ü∂ Deshacer';
    btnReset.parentElement?.insertBefore(undoBtn, btnReset.nextSibling);
  }
  if(undoBtn) undoBtn.addEventListener('click', undoLast);
}
function init(){
  populateOptionsUI();
  applyDimHeader();
  buildLevels();
  buildBank();
  setTimeFromInputs(); updateTimer();
  ensureUndoButton();

  // Delegaci√≥n: tocar zona de nivel o pastilla
  levelsEl.addEventListener('click', (ev)=>{
    // 1) Pastillas
    const pill = ev.target.closest('.pill');
    if(pill){
      const lvl = +pill.dataset.level;
      const box = levelsEl.querySelector(`.lvl[data-level="${lvl}"]`);
      const drop = box.querySelector('.drop');
      if(HAPTICS() && navigator.vibrate) navigator.vibrate(12);
      pill.classList.add('flash'); setTimeout(()=>pill.classList.remove('flash'), 180);
      onLevelTap(lvl, box, drop);
      return;
    }
    // 2) Caja de nivel
    const box = ev.target.closest('.lvl');
    if(!box) return;
    const lvl = +box.dataset.level;
    const drop = box.querySelector('.drop');
    onLevelTap(lvl, box, drop);
  }, {passive:true});
}
init();

/* ================== Build niveles ================== */
function buildLevels(){
  levelsEl.innerHTML = "";
  const scale = document.createElement('div');
  scale.className = 'pillbar';
  scale.innerHTML = `
    <div class="pill p1" data-level="1">1</div>
    <div class="pill p2" data-level="2">2</div>
    <div class="pill p3" data-level="3">3</div>
    <div class="pill p4" data-level="4">4</div>
  `;
  levelsEl.appendChild(scale);

  const names = ["Nivel 1 ‚Äì Bajo","Nivel 2 ‚Äì B√°sico","Nivel 3 ‚Äì Alto","Nivel 4 ‚Äì Superior"];
  for (let lvl = 1; lvl <= 4; lvl++){
    const box  = document.createElement('div');
    box.className = 'lvl';
    box.dataset.level = String(lvl);

    const h4 = document.createElement('h4');
    h4.textContent = names[lvl-1];

    const placed = new Set(CARDS.filter(c => c.locked && c.level === lvl).map(c => c.verb));
    const remaining = DATA[currentDim][lvl].filter(v => !placed.has(v));

    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.dataset.hint = String(lvl);
    hint.textContent = remaining.join(', ');
    if (examChk.checked || remaining.length === 0) hint.classList.add('hidden');

    const count = document.createElement('div');
    count.className = 'count';
    count.textContent = ''; // se completa luego

    const drop = document.createElement('div');
    drop.className = 'drop';
    drop.dataset.level = String(lvl);

    box.appendChild(h4);
    box.appendChild(hint);
    box.appendChild(count);
    box.appendChild(drop);
    levelsEl.appendChild(box);
  }
  updateAllLevelCounters();
}

/* ================== UNDO ================== */
function undoLast(){
  const move = undoStack.pop();
  if(!move) return;
  // Quitar lock y devolver al banco
  const c = CARDS.find(x=>x.el===move.el);
  if(c){ c.locked = false; }
  move.el.classList.remove('ok','selected');
  bankEl.appendChild(move.el);

  // Devolver a la pista y contadores
  addBackToHint(move.level, move.verb);
  updateLevelCounter(move.level);

  // Ajustar puntos
  points -= POINT_CORRECT;
  updateCounters();
}
</script>
</body>
</html>
