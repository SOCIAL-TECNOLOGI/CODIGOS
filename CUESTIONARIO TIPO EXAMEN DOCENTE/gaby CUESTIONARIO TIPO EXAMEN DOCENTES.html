<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Constructor Dinámico de Cuestionarios - Exportable</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    .hidden { display:none; }
    .container { max-width:900px; margin:0 auto; }
    button { padding:8px 16px; margin:4px; border:none; border-radius:4px; background:#25447e; color:#fff; cursor:pointer; }
    button:hover { background:#3366cc; }
    .pregunta, .builder-form { border:1px solid #ccc; border-radius:8px; padding:12px; margin:12px 0; background:#f5f5f5; }
    .opcion-builder { margin:6px 0; }
    #lista-preguntas div { margin:4px 0; }
    #lista-preguntas button { margin-left:8px; background:#e74c3c; }
    #lista-preguntas button.btn-editar { background:#f39c12; }
  </style>
</head>
<body>
<div class="container">
  <h1>Constructor Dinámico de Cuestionarios</h1>
  <button id="btn-abrir-builder">Crear Preguntas</button>

  <div id="builder-container" class="builder-form hidden">
    <h2>Agregar Nueva Pregunta</h2>
    <label>Enunciado:</label><br>
    <textarea id="txt-enunciado" rows="3" style="width:100%;"></textarea><br>
    <label>Imagen (opcional):</label>
    <input type="file" id="file-imagen" accept="image/*"><br>
    <label>Explicación (opcional):</label><br>
    <textarea id="txt-explicacion" rows="2" style="width:100%;"></textarea><br>
    <label>Link Refuerzo (opcional):</label>
    <input type="url" id="txt-refuerzo" style="width:100%;" placeholder="https://..."><br>
    <div id="opciones-container"><h3>Opciones de Respuesta</h3></div>
    <button id="btn-add-opcion">+ Agregar Opción</button>
    <button id="btn-save-pregunta">Guardar Pregunta</button>
    <div id="lista-preguntas"></div>
    <button id="btn-finalizar" class="hidden">Finalizar y Preparar Exportación</button>
  </div>

  <div id="export-container" class="hidden">
    <h2>Descargar Cuestionario</h2>
    <button id="btn-export-word">Descargar Word</button>
  </div>
</div>

<script>
let preguntas = [];
let editingIndex = null;

const editor = document.getElementById('builder-container');
const listaPreg = document.getElementById('lista-preguntas');
const btnAbrir = document.getElementById('btn-abrir-builder');
const btnAddOpt = document.getElementById('btn-add-opcion');
const btnSave = document.getElementById('btn-save-pregunta');
const btnFinal = document.getElementById('btn-finalizar');
const exportCont = document.getElementById('export-container');
const btnExportWord = document.getElementById('btn-export-word');

btnAbrir.onclick = () => {
  editor.classList.toggle('hidden');
  cancelEdit();
  refreshListaPreguntas();
};

btnAddOpt.onclick = () => {
  const idx = document.querySelectorAll('.opcion-builder').length;
  const div = document.createElement('div');
  div.classList.add('opcion-builder');
  div.innerHTML = `
    <input type="radio" name="correcta" value="${idx}">
    <input type="text" placeholder="Texto opción" style="width:80%;">
  `;
  document.getElementById('opciones-container').appendChild(div);
};

async function savePregunta() {
  const enun = document.getElementById('txt-enunciado').value.trim();
  if (!enun) { alert('Enunciado requerido.'); return; }

  const exp = document.getElementById('txt-explicacion').value.trim();
  const ref = document.getElementById('txt-refuerzo').value.trim();
  let imgSrc = '';

  const imgFile = document.getElementById('file-imagen').files[0];
  if (imgFile) {
    imgSrc = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          const DPI = 96;
          const TARGET_CM = 17.5;
          const MAX_WIDTH = (TARGET_CM / 2.54) * DPI; // convierte cm a px
          const scale = Math.min(1, MAX_WIDTH / img.width);

          const canvas = document.createElement('canvas');
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          const base64 = canvas.toDataURL("image/jpeg", 0.9);
          if (base64.startsWith("data:image/jpeg;base64,")) {
            resolve(base64);
          } else {
            alert("La imagen no se pudo procesar correctamente.");
            resolve("");
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(imgFile);
    });
  }

  const opts = Array.from(document.querySelectorAll('.opcion-builder'))
    .map(div => div.querySelector('input[type=text]').value.trim());
  const sel = document.querySelector('input[name=correcta]:checked');
  if (opts.length < 2 || !sel) {
    alert('Al menos 2 opciones y marca la correcta.');
    return;
  }

  const correctIdx = +sel.value;
  const correctLetter = String.fromCharCode(97 + correctIdx);
  const nueva = { enun, imgSrc, opts, correctIdx, correctLetter, exp, ref };
  if (editingIndex === null) preguntas.push(nueva);
  else preguntas[editingIndex] = nueva;

  cancelEdit();
  refreshListaPreguntas();
  btnFinal.classList.remove('hidden');
}
btnSave.onclick = savePregunta;

function refreshListaPreguntas() {
  listaPreg.innerHTML = '';
  preguntas.forEach((q, i) => {
    const div = document.createElement('div');
    div.innerHTML = `Pregunta ${i + 1}: ${q.enun.substring(0, 50)}...
      <button class="btn-editar" data-i="${i}">Editar</button>
      <button class="btn-eliminar" data-i="${i}">Eliminar</button>`;
    listaPreg.appendChild(div);
  });

  document.querySelectorAll('.btn-editar').forEach(b =>
    b.onclick = () => startEdit(+b.dataset.i));
  document.querySelectorAll('.btn-eliminar').forEach(b =>
    b.onclick = () => {
      preguntas.splice(+b.dataset.i, 1);
      if (editingIndex === +b.dataset.i) cancelEdit();
      refreshListaPreguntas();
    });
}

function startEdit(i) {
  const q = preguntas[i];
  editingIndex = i;
  document.getElementById('txt-enunciado').value = q.enun;
  document.getElementById('txt-explicacion').value = q.exp;
  document.getElementById('txt-refuerzo').value = q.ref;
  document.getElementById('file-imagen').value = '';
  const cont = document.getElementById('opciones-container');
  cont.innerHTML = '<h3>Opciones de Respuesta</h3>';
  q.opts.forEach((opt, j) => {
    const d = document.createElement('div');
    d.classList.add('opcion-builder');
    d.innerHTML = `
      <input type="radio" name="correcta" value="${j}" ${j === q.correctIdx ? 'checked' : ''}>
      <input type="text" style="width:80%;" value="${opt}">
    `;
    cont.appendChild(d);
  });
  btnSave.textContent = 'Actualizar Pregunta';
}

function cancelEdit() {
  editingIndex = null;
  btnSave.textContent = 'Guardar Pregunta';
  document.getElementById('txt-enunciado').value = '';
  document.getElementById('txt-explicacion').value = '';
  document.getElementById('txt-refuerzo').value = '';
  document.getElementById('file-imagen').value = '';
  document.getElementById('opciones-container').innerHTML = '<h3>Opciones de Respuesta</h3>';
}

btnFinal.onclick = () => {
  editor.classList.add('hidden');
  exportCont.classList.remove('hidden');
};

function exportToWord() {
  let html = '<h1>Cuestionario</h1>';
  preguntas.forEach((q, i) => {
    html += `<h3>${i + 1}. ${q.enun}</h3>`;

    if (q.imgSrc && q.imgSrc.startsWith("data:image/jpeg")) {
      html += `<div style="text-align:center; margin-bottom:8px;">
        <img src="${q.imgSrc}" 
             style="width:15.5cm; height:auto; display:block; margin-left:auto; margin-right:auto;">
      </div>`;
    }

    html += '<ul>';
    q.opts.forEach((opt, j) => {
      html += `<li>${String.fromCharCode(65 + j)}) ${opt}</li>`;
    });
    html += '</ul>';
  });

  const converted = htmlDocx.asBlob(html);
  saveAs(converted, 'Cuestionario.docx');
}
btnExportWord.onclick = exportToWord;
</script>

</body>
</html>
