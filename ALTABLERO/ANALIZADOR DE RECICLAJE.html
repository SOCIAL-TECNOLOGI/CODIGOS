<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Reciclaje</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .empty-cell {
            background-color: rgba(255, 182, 193, 0.5); /* Color rojo pastel suave */
        }
        #myChart, #dailyChart {
            margin-top: 20px;
            width: 100%;
            height: 400px;
            display: none; 
        }
        #impactResult {
            margin-top: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Registro de Reciclaje</h1>
<textarea id="inputData" placeholder="Pega aquí la información sobre reciclaje..."></textarea>
<br>
<button onclick="processData()">Procesar Datos</button>
<button onclick="sortTable()">Ordenar de Mayor a Menor</button>
<button onclick="showChart()">Ver Gráfico</button>
<button onclick="updateChart()">Actualizar Gráfico</button>
<button onclick="showDailyChart()">Ver Gráfico Diario</button>

<table id="outputTable">
    <thead>
        <tr>
            <th>Nº</th>
            <th>Nombre Estudiante</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="impactResult"></div> <!-- Sección para mostrar el impacto ambiental -->

<canvas id="myChart"></canvas>
<canvas id="dailyChart"></canvas>

<script>
    let currentData = []; 
    let dates = []; 

    // Definición de los datos de reciclaje por lata y botella
    const recyclingData = {
        lata: { peso: 12, energia: 0.168, agua: 0.0168, co2: 0.108 }, // por lata
        botella: { peso: 13, energia: 0.224, agua: 0.0234, co2: 0.0195 } // por botella
    };

    function processData() {
    const input = document.getElementById('inputData').value.trim();
    const lines = input.split('\n');
    const outputTable = document.getElementById('outputTable').getElementsByTagName('tbody')[0];

    outputTable.innerHTML = '';
    currentData = []; 
    dates = []; 

    const headerRow = lines[0].split('\t');
    const header = document.getElementById('outputTable').getElementsByTagName('thead')[0];

    while (header.rows.length > 1) {
        header.deleteRow(1);
    }

    const newHeaderRow = header.insertRow(1);
    newHeaderRow.insertCell(0).textContent = 'Nº';
    newHeaderRow.insertCell(1).textContent = 'Nombre Estudiante';

    // Modificación: Capturar las fechas comenzando desde el primer día
    for (let i = 2; i < headerRow.length; i += 2) {
        const cell = newHeaderRow.insertCell();
        cell.colSpan = 2; 
        dates.push(headerRow[i]); // Almacena correctamente la fecha desde el primer día
        cell.textContent = headerRow[i];
    }

    const studentData = lines.slice(1);
    studentData.forEach(line => {
        if (line.trim() === '') return; 
        const data = line.split('\t');

        if (data[0] && data[1]) {
            const row = outputTable.insertRow();
            currentData.push(data); 

            for (let i = 0; i < data.length; i++) {
                const cell = row.insertCell(i);
                cell.textContent = data[i] || ''; 
                if (!data[i]) { 
                    cell.classList.add('empty-cell');
                }
            }
        }
    });

    calculateImpact();
}

function calculateImpact() {
    const impactResultDiv = document.getElementById('impactResult');
    const dailyTotals = {};

    for (let data of currentData) {
        for (let i = 2; i < data.length; i += 2) {
            if (i + 1 >= data.length) break;

            const dateIndex = Math.floor((i - 2) / 2); 
            if (dateIndex >= dates.length) break;

            const date = dates[dateIndex];
            const cans = parseInt(data[i]) || 0;
            const bottles = parseInt(data[i + 1]) || 0;

            if (!dailyTotals[date]) {
                dailyTotals[date] = { cans: 0, bottles: 0 };
            }

            dailyTotals[date].cans += cans;
            dailyTotals[date].bottles += bottles;
        }
    }

    // Mostrar el impacto ambiental
    let impactHtml = '<h2>Impacto Ambiental Diario por Material</h2>';
    impactHtml += '<table><tr><th>Fecha</th><th>Peso Latas (kg)</th><th>Peso Botellas (kg)</th><th>Energía Latas (kWh)</th><th>Energía Botellas (kWh)</th><th>Agua Latas (m³)</th><th>Agua Botellas (m³)</th><th>CO₂ Latas (kg)</th><th>CO₂ Botellas (kg)</th></tr>';

    for (const date in dailyTotals) {
        const totalCans = dailyTotals[date].cans;
        const totalBottles = dailyTotals[date].bottles;

        const pesoLatas = (totalCans * recyclingData.lata.peso) / 1000;
        const pesoBotellas = (totalBottles * recyclingData.botella.peso) / 1000;
        const energiaLatas = totalCans * recyclingData.lata.energia;
        const energiaBotellas = totalBottles * recyclingData.botella.energia;
        const aguaLatas = totalCans * recyclingData.lata.agua;
        const aguaBotellas = totalBottles * recyclingData.botella.agua;
        const co2Latas = totalCans * recyclingData.lata.co2;
        const co2Botellas = totalBottles * recyclingData.botella.co2;

        impactHtml += `<tr>
            <td>${date}</td>
            <td>${pesoLatas.toFixed(2)}</td>
            <td>${pesoBotellas.toFixed(2)}</td>
            <td>${energiaLatas.toFixed(2)}</td>
            <td>${energiaBotellas.toFixed(2)}</td>
            <td>${aguaLatas.toFixed(2)}</td>
            <td>${aguaBotellas.toFixed(2)}</td>
            <td>${co2Latas.toFixed(2)}</td>
            <td>${co2Botellas.toFixed(2)}</td>
        </tr>`;
    }

    impactHtml += '</table>';
    impactResultDiv.innerHTML = impactHtml;
}

    function sortTable() {
        const sortableData = currentData.map((data, index) => {
            const totalRecycling = data.slice(2).reduce((total, num) => total + (parseInt(num) || 0), 0);
            return { index, data, totalRecycling };
        });

        sortableData.sort((a, b) => b.totalRecycling - a.totalRecycling);

        const outputTable = document.getElementById('outputTable').getElementsByTagName('tbody')[0];
        outputTable.innerHTML = '';

        sortableData.forEach(item => {
            const row = outputTable.insertRow();
            item.data.forEach((cellData, i) => {
                const cell = row.insertCell(i);
                cell.textContent = cellData || ''; 
                if (!cellData) { // Si la celda está vacía
                    cell.classList.add('empty-cell'); // Añadir la clase para el color
                }
            });
        });

        drawChart(sortableData.map(item => item.data));
    }

    function showChart() {
        if (currentData.length > 0) {
            drawChart(currentData);
            document.getElementById('myChart').style.display = 'block'; 
            document.getElementById('dailyChart').style.display = 'none'; 
        } else {
            alert('Por favor, procesa los datos primero.');
        }
    }

    function updateChart() {
    if (currentData.length > 0) {
        const outputTable = document.getElementById('outputTable').getElementsByTagName('tbody')[0];
        const rows = outputTable.getElementsByTagName('tr');
        const updatedData = [];

        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            if (cells.length > 0) {
                const rowData = [];
                for (let cell of cells) {
                    rowData.push(cell.textContent);
                }
                updatedData.push(rowData);
            }
        }

        // Ordenar los datos por total reciclado (latas + botellas)
        const sortableData = updatedData.map((data, index) => {
            const totalRecycling = data.slice(2).reduce((total, num) => total + (parseInt(num) || 0), 0);
            return { index, data, totalRecycling };
        });

        sortableData.sort((a, b) => b.totalRecycling - a.totalRecycling);

        // Dibujar el gráfico con los datos ordenados
        drawChart(sortableData.map(item => item.data));
    } else {
        alert('Por favor, procesa los datos primero.');
    }
}

function showDailyChart() {
    calculateImpact(); // Asegura que los datos estén actualizados
    drawDailyChart();
    document.getElementById('dailyChart').style.display = 'block'; // Asegura visibilidad
    document.getElementById('myChart').style.display = 'none'; 
}

    function drawChart(dataToUse) {
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChartInstance = Chart.getChart('myChart'); 

        const labels = dataToUse.map(item => item[1]); 
        const recyclingAmounts = dataToUse.map(item => {
            return item.slice(2).reduce((total, num) => total + (parseInt(num) || 0), 0); 
        });

        if (myChartInstance) {
            myChartInstance.destroy();
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total de Reciclaje',
                    data: recyclingAmounts,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function drawDailyChart() {
    const dailyLabels = Object.keys(dailyTotals); // Fechas
    const totalCans = dailyLabels.map(date => dailyTotals[date].cans);
    const totalBottles = dailyLabels.map(date => dailyTotals[date].bottles);

    const ctx = document.getElementById('dailyChart').getContext('2d');
    const dailyChartInstance = Chart.getChart('dailyChart');

    // Destruir el gráfico anterior si existe
    if (dailyChartInstance) {
        dailyChartInstance.destroy();
    }

    // Crear el nuevo gráfico con todos los datos actualizados
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dailyLabels, // Usar las fechas actualizadas
            datasets: [
                {
                    label: 'Total Latas',
                    data: totalCans,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Total Botellas',
                    data: totalBottles,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}


</script>

</body>
</html>
