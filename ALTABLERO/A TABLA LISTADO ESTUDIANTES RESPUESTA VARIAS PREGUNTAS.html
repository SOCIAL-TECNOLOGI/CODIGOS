<!DOCTYPE html>  
<html lang="es">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Análisis de Respuestas</title>  
    <link rel="stylesheet" href="styles.css">  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js"></script>  

    <style>  
        body {  
            font-family: sans-serif;  
        }  
        table {  
            border-collapse: collapse;  
            width: 100%;  
            margin-bottom: 20px;  
        }  
        th, td {  
            border: 1px solid #ddd;  
            padding: 8px;  
            text-align: left;  
        }  
        th {  
            background-color: #f2f2f2;  
        }  
        .tab {  
            overflow: hidden;  
            border: 1px solid #ccc;  
            background-color: #f1f1f1;  
        }  
        .tab button {  
            background-color: inherit;  
            float: left;  
            border: none;  
            outline: none;  
            cursor: pointer;  
            padding: 14px 16px;  
            transition: 0.3s;  
        }  
        .tab button:hover {  
            background-color: #ddd;  
        }  
        .tab button.active {  
            background-color: #ccc;  
        }  
        .tabcontent {  
            display: none;  
            padding: 6px 12px;  
            border: 1px solid #ccc;  
            border-top: none;  
        }  
        #dataInput {  
            display: none; /* Ocultar el área de texto por defecto */  
        }  

        .tab button.active {  
    background-color: #ccc; /* Color de fondo para la pestaña activa */  
    font-weight: bold; /* Poner en negrita la pestaña activa */  
}  


#dataInputContainer {  
    margin-top: 10px; /* Añade un margen superior */  
}  

textarea {  
    width: 100%; /* Asegurarse de que el área de texto use el ancho completo */  
    height: 150px; /* Ajusta la altura para que sea visible */  
    padding: 10px; /* Espacio dentro del área de texto */  
    border: 1px solid #ccc; /* Borde para distinguirlo */  
    border-radius: 4px; /* Bordes redondeados */  
    resize: vertical; /* Permitir cambio de tamaño solo verticalmente */  
}  

    </style>  

  
    </head>  
    <body>  
        <h1>Análisis de Respuestas</h1>  
    
        <button id="toggleTextArea">Mostrar/Ocultar Área de Texto</button>  
        <div id="dataInputContainer" style="display: none;">  
            <textarea id="dataInput" rows="10" placeholder="Ingresa los datos aquí..."></textarea>  
        </div>  
    
        <br>  
        <label for="respuestaCorrecta">Respuestas Correctas (separadas por comas):</label>  
        <input type="text" id="respuestaCorrecta" placeholder="Ej: A,B,C" />  
        <br>  
        <label for="urlRefuerzo">URLs de Refuerzo (separadas por comas):</label>  
        <input type="text" id="urlRefuerzo" placeholder="Ej: https://www.ejemplo.com/refuerzo1,https://www.ejemplo.com/refuerzo2" />  
        <br>  
        <button id="analyzeButton">Analizar Datos</button>  
        <button id="downloadCSVButton">Descargar CSV</button>  
        <button id="downloadChartButton">Descargar Gráfico</button>  
        <div id="responseChartContainer" style="height: 400px;"></div>   
        <div id="results"></div>  
      
        <script src="script.js"></script>  
   

<script>

document.getElementById('analyzeButton').addEventListener('click', function() {  
    const data = document.getElementById('dataInput').value;  
    const lines = data.trim().split('\n');  
    const results = {};  
    const estudiantesRegistrados = {};  
    const respuestasCorrectas = document.getElementById('respuestaCorrecta').value.split(',').map(res => res.toUpperCase().trim());  
    const urlRefuerzo = document.getElementById('urlRefuerzo').value;  

    processLines(lines, results, estudiantesRegistrados, respuestasCorrectas, urlRefuerzo);  
    generateResultsHTML(results, respuestasCorrectas, urlRefuerzo);  
    generateCharts(results);  
});  



function processLines(lines, results, estudiantesRegistrados, respuestasCorrectas, urlRefuerzo) {  
    lines.slice(1).forEach(line => {  
        const parts = line.split('\t');  
        if (parts.length > 3) {  
            const sede = parts[0].trim();  
            const nombres = parts[1].trim();  
            const apellidos = parts[2].trim();  
            const nombreCompleto = (nombres + ' ' + apellidos).toUpperCase();  

            if (!results[sede]) {  
                results[sede] = {};  
                estudiantesRegistrados[sede] = {};  
            }  

            for (let i = 0; i < respuestasCorrectas.length; i++) {  
                const respuesta = parts[i + 3]?.trim().toUpperCase(); // Respuestas empiezan desde el índice 3  
                if (!estudiantesRegistrados[sede][nombreCompleto]) {  
                    if (!results[sede][i]) {  
                        results[sede][i] = { 'correctas': {}, 'incorrectas': {}, 'total': 0 };  
                    }  

                    const esCorrecta = respuesta === respuestasCorrectas[i];  
                    if (esCorrecta) {  
                        if (!results[sede][i].correctas[respuesta]) {  
                            results[sede][i].correctas[respuesta] = [];  
                        }  
                        results[sede][i].correctas[respuesta].push(nombreCompleto);  
                    } else {  
                        if (!results[sede][i].incorrectas[respuesta]) {  
                            results[sede][i].incorrectas[respuesta] = [];  
                        }  
                        results[sede][i].incorrectas[respuesta].push(nombreCompleto);  
                    }  
                    results[sede][i].total++;  
                    estudiantesRegistrados[sede][nombreCompleto] = true; // Marcar estudiante como registrado  
                }  
            }  
        }  
    });  
}  




function generateResultsHTML(results, respuestasCorrectas, urlRefuerzo) {  
    let html = '';  

    for (const sede in results) {  
        html += `<h2>${sede}</h2>`;  
        html += `<div class="tab">`;  
        
        for (let preguntaIndex in results[sede]) {  
            html += `<button class="tablinks" onclick="openTab(event, '${sede}-pregunta${preguntaIndex}')">Pregunta ${parseInt(preguntaIndex) + 1}</button>`;  
        }  
        html += `</div>`;  

        for (let preguntaIndex in results[sede]) {  
            html += `<div id="${sede}-pregunta${preguntaIndex}" class="tabcontent" style="display: none;">`;  
            html += `<table><thead><tr><th>Respuesta Correcta</th><th>Nombres</th></tr></thead><tbody>`;  

            for (const respuesta in results[sede][preguntaIndex].correctas) {  
                results[sede][preguntaIndex].correctas[respuesta].forEach(name => {  
                    html += `<tr><td>${respuesta}</td><td>${name}</td></tr>`;  
                });  
            }  
            html += '</tbody></table></div>';  
        }  
    }  

    document.getElementById('results').innerHTML = html;  
    const firstTab = document.querySelector('.tablinks');  
    if (firstTab) {  
        firstTab.click(); // Activar la primera pestaña por defecto  
    }  
}  



function generateCharts(results) {  
    const ctxContainer = document.getElementById('responseChartContainer');  
    ctxContainer.innerHTML = ''; // Limpiar gráficos anteriores  

    for (const sede in results) {  
        for (let preguntaIndex in results[sede]) {  
            const correctas = results[sede][preguntaIndex].correctas;  
            const total = results[sede][preguntaIndex].total;  
            const counts = Object.values(correctas).map(arr => arr.length);  
            const labels = Object.keys(correctas);  

            const canvas = document.createElement('canvas');  
            const ctx = canvas.getContext('2d');  
            ctxContainer.appendChild(canvas);  

            new Chart(ctx, {  
                type: 'bar',  
                data: {  
                    labels: labels,  
                    datasets: [{  
                        label: '% Correctas',  
                        data: counts.map(count => (count / total) * 100),  
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',  
                        borderColor: 'rgba(75, 192, 192, 1)',  
                        borderWidth: 1  
                    }]  
                },  
                options: {  
                    scales: {  
                        y: {  
                            beginAtZero: true,  
                            max: 100  
                        }  
                    },  
                    plugins: {  
                        legend: {  
                            display: true  
                        },  
                        tooltip: {  
                            callbacks: {  
                                label: (context) => {  
                                    const label = context.label || '';  
                                    const count = counts[context.dataIndex];  
                                    return `${label}: ${context.raw.toFixed(2)}% (${count} respuestas)`;  
                                }  
                            }  
                        }  
                    }  
                }  
            });  
        }  
    }  
}  


// Función para abrir la pestaña seleccionada  
function openTab(event, tabName) {  
    // Obtener todas las pestañas  
    var i, tabcontent, tablinks;  
    tabcontent = document.getElementsByClassName("tabcontent");  
    for (i = 0; i < tabcontent.length; i++) {  
        tabcontent[i].style.display = "none"; // Ocultar todas las pestañas  
    }  
    
    // Obtener todos los botones y quitar la clase "active"  
    tablinks = document.getElementsByClassName("tablinks");  
    for (i = 0; i < tablinks.length; i++) {  
        tablinks[i].className = tablinks[i].className.replace(" active", "");  
    }  
    
    // Mostrar la pestaña actual y agregar la clase "active" al botón que lo abrió  
    document.getElementById(tabName).style.display = "block";  
    event.currentTarget.className += " active";  
}  


// Función para mostrar u ocultar el área de texto  
document.getElementById('toggleTextArea').addEventListener('click', function() {  
    const dataInputContainer = document.getElementById('dataInputContainer');  
    if (dataInputContainer.style.display === 'none' || dataInputContainer.style.display === '') {  
        dataInputContainer.style.display = 'block'; // Mostrar el área de texto  
    } else {  
        dataInputContainer.style.display = 'none'; // Ocultar el área de texto  
    }  
});  




</script>