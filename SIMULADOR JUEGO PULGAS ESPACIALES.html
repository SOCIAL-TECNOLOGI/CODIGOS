<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego Espacial – Jacobo vs Pulgas</title>
<style>
  body {
    background:#000;
    margin:0;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    overflow:hidden;
  }
  canvas {
    border:3px solid #22d3ee;
    background: radial-gradient(circle at center, #0f172a 0%, #000 100%);
  }
</style>
</head>
<body>
<canvas id="game" width="700" height="500"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// === NAVE ===
let nave = { x: canvas.width/2 - 25, y: 430, w: 50, h: 50 };

// === PULGAS ===
let pulgas = [];
function crearPulga(){
  return { x: Math.random()*(canvas.width-40)+20, y: -40, w: 40, h: 40, v: 2+Math.random()*2, vivo: true };
}
for (let i=0;i<6;i++) pulgas.push(crearPulga());

// === BALAS ===
let balas = [];

// === PUNTAJE Y VIDAS ===
let score = 0;
let vidas = 7;
let pulgasEscapadas = 0;

// === POWERUPS ===
let powerups = [];
let poderes = { triple:false, fuego:false, hielo:false, escudo:false };
let timers = { triple:0, fuego:0, hielo:0, escudo:0 };

// === SISTEMA DE PUNTAJE ===
const PUNTOS_PULGA = 50;   // base
const PUNTOS_ESCUDO = 20;  // con escudo
let lastKillTime = 0;
let combo = 0;

// === CONTROLES ===
let keys = { left:false, right:false, space:false };
document.addEventListener("keydown", e=>{
  if(e.key==="ArrowLeft") keys.left=true;
  if(e.key==="ArrowRight") keys.right=true;
  if(e.key===" " && !keys.space){
    keys.space=true; disparar();
  }
});
document.addEventListener("keyup", e=>{
  if(e.key==="ArrowLeft") keys.left=false;
  if(e.key==="ArrowRight") keys.right=false;
  if(e.key===" ") keys.space=false;
});

// === AUDIO ===
let audioCtx;
function beep(freq,type,dur){
  try{
    audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.value=0.001; o.connect(g); g.connect(audioCtx.destination);
    const t=audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.2,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.start(); o.stop(t+dur);
  }catch(e){}
}
function sonidoHit(){beep(700,"triangle",0.3);}
function sonidoFail(){beep(180,"sawtooth",0.4);}
function sonidoVida(){beep(1000,"sine",0.5);}
function sonidoPower(){beep(500,"square",0.6);}

// === DIBUJAR ===
function drawNave(x,y,w,h){
  ctx.save(); ctx.translate(x+w/2,y+h/2); ctx.scale(w/60,h/60);
  ctx.fillStyle="#3b82f6";
  ctx.beginPath(); ctx.moveTo(0,-30); ctx.lineTo(20,20); ctx.lineTo(-20,20); ctx.closePath(); ctx.fill();
  ctx.fillStyle="#22d3ee"; ctx.beginPath(); ctx.arc(0,-10,8,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="#60a5fa"; ctx.fillRect(-30,0,15,10); ctx.fillRect(15,0,15,10);
  ctx.restore();
}
function drawPulga(p){
  if(!p.vivo) return;
  ctx.save(); ctx.translate(p.x,p.y);
  ctx.fillStyle="limegreen"; ctx.beginPath(); ctx.ellipse(0,0,p.w/2,p.h/2,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(-8,-5,6,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(8,-5,6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="black"; ctx.beginPath(); ctx.arc(-8,-5,2,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(8,-5,2,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle="black"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(-12,-15); ctx.lineTo(-18,-30); ctx.moveTo(12,-15); ctx.lineTo(18,-30); ctx.stroke();
  ctx.restore();
}
function drawBala(b){ ctx.fillStyle=b.color; ctx.fillRect(b.x,b.y,b.w,b.h); }
function drawPowerup(p){ ctx.font="20px Arial"; ctx.fillText(p.icon,p.x,p.y); }
function drawHUD(){
  ctx.fillStyle="white"; ctx.font="18px Arial";
  ctx.fillText("Puntos: "+score,20,30);
  ctx.fillText("Vidas: "+ "❤️".repeat(vidas),20,55);
  let y=80;
  for(const k of Object.keys(poderes)){
    if(poderes[k]){
      let icon = k==="escudo"?"🛡️":(k==="triple"?"⚡":(k==="fuego"?"🔥":"❄️"));
      ctx.fillStyle="#facc15";
      ctx.fillText(icon+" "+k.toUpperCase()+" ("+Math.ceil(timers[k]/60)+"s)",20,y);
      y+=20;
    }
  }
}
function drawEscudo(){
  if(poderes.escudo){
    ctx.fillStyle="rgba(34,211,238,0.4)";
    ctx.fillRect(0, canvas.height-30, canvas.width, 10);
  }
}

// === DISPARAR ===
function disparar(){
  if(poderes.triple){
    balas.push({x:nave.x+nave.w/2-2,y:nave.y-10,w:4,h:10,v:-8,color:"yellow"});
    balas.push({x:nave.x+nave.w/2-15,y:nave.y-10,w:4,h:10,v:-8,color:"yellow"});
    balas.push({x:nave.x+nave.w/2+10,y:nave.y-10,w:4,h:10,v:-8,color:"yellow"});
  }
  else if(poderes.fuego){
    balas.push({x:nave.x+nave.w/2-5,y:nave.y-10,w:10,h:14,v:-9,color:"red"});
  }
  else if(poderes.hielo){
    balas.push({x:nave.x+nave.w/2-3,y:nave.y-10,w:6,h:12,v:-7,color:"aqua",piercing:true});
  }
  else{
    balas.push({x:nave.x+nave.w/2-2,y:nave.y-10,w:4,h:10,v:-8,color:"yellow"});
  }
}

// === LOOP PRINCIPAL ===
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(keys.left) nave.x-=8;
  if(keys.right) nave.x+=8;
  nave.x=Math.max(0,Math.min(canvas.width-nave.w,nave.x));
  drawNave(nave.x,nave.y,nave.w,nave.h);

  // ESCUDO
  drawEscudo();

  pulgas.forEach(p=>{
    if(p.vivo){
      p.y+=p.v;

      // Colisión con ESCUDO
      if(poderes.escudo && p.y > canvas.height-40){
        p.vivo=false;
        score+=PUNTOS_ESCUDO;
        sonidoHit();
        setTimeout(()=>pulgas.push(crearPulga()),1000);
      }

      if(p.y>canvas.height+40){
        pulgasEscapadas++;
        if(pulgasEscapadas>=3){ vidas--; pulgasEscapadas=0; sonidoFail();}
        p.y=-40; p.x=Math.random()*(canvas.width-40)+20; p.v=2+Math.random()*2;
      }
    }
    drawPulga(p);
  });

  balas.forEach(b=>{
    b.y+=b.v; drawBala(b);
    pulgas.forEach(p=>{
      if(p.vivo &&
        b.x < p.x+p.w/2 && b.x+b.w > p.x-p.w/2 &&
        b.y < p.y+p.h/2 && b.y+b.h > p.y-p.h/2){
          p.vivo=false; if(!b.piercing) b.y=-50;

          // Combo y puntaje alto
          let now = performance.now();
          if(now - lastKillTime < 2000){ combo++; } else { combo=0; }
          lastKillTime = now;
          let puntosGanados = PUNTOS_PULGA + combo*10;
          score += puntosGanados;

          sonidoHit();

          // Canje puntos → vida
          if(score>=200){ vidas++; score-=200; sonidoVida(); }

          // powerup aleatorio
          if(Math.random()<0.25){ 
            let tipos=["vida","triple","fuego","hielo","escudo"];
            let tipo=tipos[Math.floor(Math.random()*tipos.length)];
            let icon={vida:"❤️",triple:"⚡",fuego:"🔥",hielo:"❄️",escudo:"💥"}[tipo];
            powerups.push({x:p.x,y:p.y,icon:icon,tipo:tipo});
          }
          setTimeout(()=>pulgas.push(crearPulga()),1000);
      }
    });
  });
  balas=balas.filter(b=>b.y>-20);

  powerups.forEach(p=>{
    p.y+=2; drawPowerup(p);
    if(p.y>canvas.height) p.coger=true;
    if(p.x>nave.x && p.x<nave.x+nave.w && p.y>nave.y && p.y<nave.y+nave.h){
      if(p.tipo==="vida"){ vidas++; sonidoVida(); }
      else if(p.tipo==="escudo"){
        if(!poderes.escudo){ poderes.escudo=true; timers.escudo=300; }
        else{ timers.escudo+=360; } // acumula duración
        sonidoPower();
      }
      else{ poderes[p.tipo]=true; timers[p.tipo]=600; sonidoPower(); }
      p.coger=true;
    }
  });
  powerups=powerups.filter(p=>!p.coger);

  for(const k of Object.keys(timers)){
    if(timers[k]>0){ timers[k]--; if(timers[k]<=0) poderes[k]=false; }
  }

  drawHUD();

  if(vidas<=0){
    ctx.fillStyle="red"; ctx.font="40px Arial Black";
    ctx.fillText("💀 GAME OVER 💀",canvas.width/2-160,canvas.height/2);
    return;
  }

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
