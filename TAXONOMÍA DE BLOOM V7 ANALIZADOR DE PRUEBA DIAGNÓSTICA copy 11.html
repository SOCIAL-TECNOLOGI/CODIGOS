<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An√°lisis Taxonom√≠a de Bloom</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9fafb; color: #333; }
  h1 { color: #1d4ed8; }
  h2 { margin-top: 30px; color: #059669; }
  input[type="file"], select, button { margin: 10px 5px; padding: 6px; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
  th, td { border: 1px solid #ddd; padding: 6px 10px; text-align: center; }
  th { background: #1d4ed8; color: #fff; }
  .ok { background: #d1fae5; }     
  .error { background: #fee2e2; }  
  #chartContainer { margin-top: 30px; max-width: 1000px; }

  /* === Nueva fila para los tres gr√°ficos === */
  #chartsRow {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 30px;
  }
  .chartBox {
    flex: 1;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
  }
  .chartBox canvas {
    width: 100% !important;
    height: 350px !important;
  }

  #chartComparativo { max-width: 600px; margin-top: 20px; }


.verbo-ok {
  color: #16a34a; /* Verde */
}

.verbo-error {
  color: #dc2626; /* Rojo */
}

.verbo-alerta {
  color: #6b7280; /* Gris */
}



</style>
</head>
<body>

<h1>üìä An√°lisis Diagn√≥stico - Taxonom√≠a de Bloom</h1>
<p>Sube el archivo Excel con los resultados de la prueba:</p>
<input type="file" id="inputExcel" accept=".xlsx,.xls" />

<div id="tablaResultados"></div>
<button id="btnExcel" style="display:none;">üì• Descargar Excel (Summary Report)</button>
<button id="btnExcelTodos" style="display:none;">üì• Descargar Consolidado (Todos los Docentes)</button>

<!-- üéØ Fila con 3 gr√°ficos en columnas -->
<div id="chartsRow">
  <div class="chartBox"><canvas id="chartDistribucion"></canvas></div>
  <div class="chartBox"><canvas id="chartTopMedia"></canvas></div>
  <div class="chartBox"><canvas id="chartTopVar"></canvas></div>
</div>

<div id="chartContainer"><canvas id="chartVerbos"></canvas></div>
<div id="tablaResponses"></div>

<h2>üìå Informe Individual</h2>
<select id="docenteSelect"><option value="">-- Selecciona un docente --</option></select>
<div id="informeDocente"></div>
<canvas id="chartComparativo"></canvas>
<br>
<button id="btnPDF" style="display:none;">üì• Descargar Informe en PDF</button>
<button id="btnExcelDocente" style="display:none;">üì• Descargar Informe en Excel</button>

<script>
// ================== DATA COMPLETA ==================
const DATA = {
  saber: {
    4: ["Evaluar","Argumentar","Justificar","Dise√±ar","Formular","Crear","Innovar","Planificar","Concebir","Dise√±ar Prompts"],
    3: ["Aplicar","Analizar","Comparar","Organizar","Diferenciar","Contrastar","Revisar","Refinar"],
    2: ["Comprender","Describir","Explicar","Interpretar","Ejemplificar","Clasificar"],
    1: ["Recordar","Identificar","Reconocer","Definir","Listar","Nombrar"]
  },
  hacer: {
    4: ["Automatizar","Optimizar","Transferir","Innovar","Trazar Estrategias","Combinar Herramientas"],
    3: ["Coordinar","Implementar","Integrar","Perfeccionar","Aplicar Con Autonom√≠a"],
    2: ["Ejecutar","Practicar","Demostrar","Operar","Utilizar Con Apoyo"],
    1: ["Imitar","Copiar","Seguir Instrucciones","Manipular Con Ayuda"]
  },
  ser: {
    4: ["Interiorizar","Liderar","Modelar","Transformar","Influir Positivamente","Validar √âticamente"],
    3: ["Valorar","Argumentar","Promover","Asumir Responsabilidades","Ser Consciente"],
    2: ["Responder","Participar","Colaborar","Respetar","Cumplir"],
    1: ["Atender","Escuchar","Aceptar","Mostrar Disposici√≥n"]
  }
};

// üîπ Funci√≥n auxiliar para poner Inicial May√∫scula en cada palabra
function toTitleCase(str) {
  return str
    ? str.toLowerCase().split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ")
    : "";
}

// Diccionario de niveles correctos
let nivelesCorrectos = {};
for (let dim in DATA) {
  for (let nivel in DATA[dim]) {
    DATA[dim][nivel].forEach(v => {
      nivelesCorrectos[v.toUpperCase()] = parseInt(nivel);
    });
  }
}

let docentes = [];
let verbosGlobal = [];
let chartComparativo = null;
let indicesVerbos = [];
let nombresVerbos = [];
let resumenExport = [];
let docenteActual = null;
let correctosGlobal = [];
let erradosGlobal = [];

// ‚¨áÔ∏è Nuevas variables de gr√°ficos
let chartDistribucion = null, chartTopMedia = null, chartTopVar = null;

document.getElementById('inputExcel').addEventListener('change', handleFile, false);
document.getElementById('docenteSelect').addEventListener('change', mostrarInforme);
document.getElementById('btnExcel').addEventListener('click', exportarExcel);
document.getElementById('btnExcelDocente').addEventListener('click', exportarExcelDocente);
document.getElementById('btnExcelTodos').addEventListener('click', exportarExcelTodos);

function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type: 'array'});

    // ---------- SUMMARY REPORT ----------
    const sheetSummary = workbook.Sheets["Summary Report"];
    const jsonSummary = XLSX.utils.sheet_to_json(sheetSummary, {header:1});
    verbosGlobal = [];
    resumenExport = [];
    let porcentajes = {1:[], 2:[], 3:[], 4:[]}, nivelPredominante = [];

    // Para top medias / variabilidad calculadas desde p1..p4
    let statsVerbos = []; // {verbo, mean, std}

    for (let i = 4; i < jsonSummary.length; i++) {
      const row = jsonSummary[i];
      if (row && row[1]) {
        let verbo = row[1].toString().trim().toUpperCase();
        if (nivelesCorrectos[verbo]) {
          verbosGlobal.push(verbo);

          // p1..p4 vienen como proporciones (0-1) en el Excel
          let p1 = parseFloat(row[2] || 0), p2 = parseFloat(row[4] || 0),
              p3 = parseFloat(row[6] || 0), p4 = parseFloat(row[8] || 0);

          // Para la tabla visual (en %)
          porcentajes[1].push((p1*100).toFixed(1));
          porcentajes[2].push((p2*100).toFixed(1));
          porcentajes[3].push((p3*100).toFixed(1));
          porcentajes[4].push((p4*100).toFixed(1));

          const niveles = [p1,p2,p3,p4];
          const pred = niveles.indexOf(Math.max(...niveles)) + 1;
          nivelPredominante.push(pred);

          // Para exportaci√≥n
          resumenExport.push({
            Verbo: verbo,
            "Nivel Correcto": "Nivel " + nivelesCorrectos[verbo],
            "%N1": (p1*100).toFixed(1) + "%",
            "%N2": (p2*100).toFixed(1) + "%",
            "%N3": (p3*100).toFixed(1) + "%",
            "%N4": (p4*100).toFixed(1) + "%",
            Predominante: "Nivel " + pred
          });

          // === C√°lculo de media y desviaci√≥n (para Top 10) ===
          const mean = 1*p1 + 2*p2 + 3*p3 + 4*p4;
          const variance =
            p1*Math.pow(1-mean,2) +
            p2*Math.pow(2-mean,2) +
            p3*Math.pow(3-mean,2) +
            p4*Math.pow(4-mean,2);
          const std = Math.sqrt(variance);
          statsVerbos.push({ verbo, mean, std });
        }
      }
    }

    // Renderizar tabla Summary
    let html = "<h2>üìë Resultados por Verbo (Summary Report)</h2>";
    html += "<table><tr><th>Verbo</th><th>Nivel Correcto</th><th>%N1</th><th>%N2</th><th>%N3</th><th>%N4</th><th>Predominante</th></tr>";
    for (let i = 0; i < verbosGlobal.length; i++) {
      const correcto = nivelesCorrectos[verbosGlobal[i]] || "-";
      const pred = nivelPredominante[i];
      const clase = (pred === correcto) ? "ok" : "error";
      html += `<tr class="${clase}"><td>${verbosGlobal[i]}</td><td>Nivel ${correcto}</td>
        <td>${porcentajes[1][i]}%</td><td>${porcentajes[2][i]}%</td>
        <td>${porcentajes[3][i]}%</td><td>${porcentajes[4][i]}%</td><td>Nivel ${pred}</td></tr>`;
    }
    html += "</table>";
    document.getElementById("tablaResultados").innerHTML = html;

    // Gr√°fico de barras (N1..N4 por verbo)
    const ctxSummary = document.getElementById("chartVerbos").getContext("2d");
    new Chart(ctxSummary, {
      type: "bar",
      data: {
        labels: verbosGlobal,
        datasets: [
          {label: "Nivel 1", data: porcentajes[1], backgroundColor: "#b91c1c"},
          {label: "Nivel 2", data: porcentajes[2], backgroundColor: "#d97706"},
          {label: "Nivel 3", data: porcentajes[3], backgroundColor: "#eab308"},
          {label: "Nivel 4", data: porcentajes[4], backgroundColor: "#65a30d"}
        ]
      },
      options: { responsive: true, scales: { y: {beginAtZero:true, max:100} } }
    });

    // ---------- RESPONSES ----------
    const sheetResponses = workbook.Sheets["Responses"];
    const jsonResponses = XLSX.utils.sheet_to_json(sheetResponses, {header:1});
    const headers = jsonResponses[0];

    indicesVerbos = [];
    nombresVerbos = [];
    headers.forEach((h, idx) => {
      if (h && h.toString().includes("Dimensi√≥n:")) {
        const match = h.match(/\[(.*?)\]/);
        const verbo = match ? match[1].trim().toUpperCase() : h;
        if (nivelesCorrectos[verbo]) { 
          indicesVerbos.push(idx);
          nombresVerbos.push(verbo);
        }
      }
    });

    docentes = [];
    for (let i = 1; i < jsonResponses.length; i++) {
      const row = jsonResponses[i];
      if (row && row[6]) {
        docentes.push({
          nombre: toTitleCase(row[6]),
          apellidos: toTitleCase(row[7]),
          telefono: row[8],
          correo: row[9],
          respuestas: row,
          puntaje: row[headers.length - 1]
        });
      }
    }

    // Tabla de docentes
    let htmlResp = "<h2>üë©‚Äçüè´ Docentes (Responses)</h2><table><tr><th>Nombre</th><th>Apellidos</th><th>Tel√©fono</th><th>Correo</th><th>Puntaje</th></tr>";
    docentes.forEach(d => {
      const clase = (parseFloat(d.puntaje) >= 40) ? "ok" : "error";
      htmlResp += `<tr class="${clase}"><td>${d.nombre}</td><td>${d.apellidos}</td><td>${d.telefono}</td><td>${d.correo}</td><td>${d.puntaje}</td></tr>`;
    });
    htmlResp += "</table>";
    document.getElementById("tablaResponses").innerHTML = htmlResp;

    // Llenar select
    const select = document.getElementById("docenteSelect");
    select.innerHTML = "<option value=''>-- Selecciona un docente --</option>";
    docentes.forEach((d,i)=> select.innerHTML += `<option value="${i}">${d.nombre} ${d.apellidos}</option>`);

    // === NUEVO: dibujar los 3 gr√°ficos en columnas ===
    const puntajes = docentes
      .map(d => parseFloat(d.puntaje))
      .filter(v => !isNaN(v));

    renderTresGraficos(puntajes, statsVerbos);

    // Mostrar botones
    document.getElementById("btnExcel").style.display = "inline-block";
    document.getElementById("btnExcelTodos").style.display = "inline-block";
  };
  reader.readAsArrayBuffer(file);
}

/* ===== Utilidades y gr√°ficos nuevos ===== */

// Histograma: agrupar puntajes por bins
function buildHistogramData(values, binSize = 5) {
  if (!values.length) return {labels:[], counts:[]};
  const min = Math.min(...values);
  const max = Math.max(...values);
  const start = Math.floor(min/binSize)*binSize;
  const end = Math.ceil(max/binSize)*binSize;
  const bins = [];
  for (let b = start; b < end; b += binSize) bins.push([b, b+binSize]);

  const counts = new Array(bins.length).fill(0);
  values.forEach(v => {
    const idx = Math.min(Math.floor((v - start)/binSize), bins.length - 1);
    counts[idx] += 1;
  });

  const labels = bins.map(([a,b]) => `${a}-${b}`);
  return {labels, counts};
}

function renderTresGraficos(puntajes, statsVerbos) {
  // 1) Distribuci√≥n de puntajes
  const hist = buildHistogramData(puntajes, 5);
  const meanScore = puntajes.length ? (puntajes.reduce((a,b)=>a+b,0)/puntajes.length) : 0;

  if (chartDistribucion) chartDistribucion.destroy();
  chartDistribucion = new Chart(document.getElementById("chartDistribucion").getContext("2d"), {
    type: "bar",
    data: { labels: hist.labels, datasets: [{label: "Docentes", data: hist.counts, backgroundColor: "rgba(29,78,216,0.7)"}]},
    options: {
      responsive: true,
      plugins: { legend: { display: false }, annotation: { } },
      scales: { x: { title: {display:true, text:"Puntaje Total (sobre 70)"} },
               y: { title: {display:true, text:"N√∫mero de Docentes"}, beginAtZero:true } }
    }
  });

  // 2) Top 10 por media (a partir de Summary Report)
  const topMedia = statsVerbos.slice().sort((a,b)=>b.mean - a.mean).slice(0,10);
  if (chartTopMedia) chartTopMedia.destroy();
  chartTopMedia = new Chart(document.getElementById("chartTopMedia").getContext("2d"), {
    type: "bar",
    data: {
      labels: topMedia.map(x => x.verbo),
      datasets: [{label: "Media de nivel", data: topMedia.map(x => x.mean), backgroundColor: "#65a30d"}]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      scales: { x: { min: 0, max: 4, title: {display:true, text:"Media"} } },
      plugins: { legend: { display:false }, title: { display:true, text:"Top 10 Verbos (Media)" } }
    }
  });

  // 3) Top 10 por desviaci√≥n est√°ndar (variabilidad)
  const topVar = statsVerbos.slice().sort((a,b)=>b.std - a.std).slice(0,10);
  if (chartTopVar) chartTopVar.destroy();
  chartTopVar = new Chart(document.getElementById("chartTopVar").getContext("2d"), {
    type: "bar",
    data: {
      labels: topVar.map(x => x.verbo),
      datasets: [{label: "Desviaci√≥n est√°ndar", data: topVar.map(x => x.std), backgroundColor: "#d97706"}]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      scales: { x: { beginAtZero:true, title: {display:true, text:"DE"} } },
      plugins: { legend: { display:false }, title: { display:true, text:"Top 10 Verbos (Variabilidad)" } }
    }
  });
}

// ------------------ INFORME INDIVIDUAL ------------------


// ================== INFO DE VERBOS (Definiciones + APA) ==================
const VERBOS_INFO = {
  SABER: {
    4: [
      {verbo:"Evaluar", definicion:"Emitir juicios fundamentados basados en criterios expl√≠citos y evidencia disponible.", referencia:"Anderson, L. W., & Krathwohl, D. R. (2001). *A taxonomy for learning, teaching, and assessing: A revision of Bloom's taxonomy of educational objectives*. Longman."},
      {verbo:"Argumentar", definicion:"Sustentar una posici√≥n utilizando premisas, contraejemplos y evidencia cr√≠tica.", referencia:"Bloom, B. S. (1956). *Taxonomy of educational objectives: The classification of educational goals. Handbook I: Cognitive domain*. Longman."},
      {verbo:"Justificar", definicion:"Defender una decisi√≥n con base en datos, razones y an√°lisis cr√≠tico.", referencia:"Krathwohl, D. R. (2002). A revision of Bloom's taxonomy: An overview. *Theory into Practice*, 41(4), 212‚Äì218."},
      {verbo:"Dise√±ar", definicion:"Proponer soluciones originales considerando restricciones y variables clave.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Formular", definicion:"Plantear hip√≥tesis o problemas investigables con supuestos claros.", referencia:"Krathwohl (2002)."},
      {verbo:"Crear", definicion:"Producir un modelo, producto o idea original integrando saberes previos.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Innovar", definicion:"Proponer mejoras in√©ditas que resuelvan problemas reales o potenciales.", referencia:"Krathwohl (2002)."},
      {verbo:"Planificar", definicion:"Organizar metas, recursos y tiempos anticipando posibles riesgos.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Concebir", definicion:"Imaginar estructuras o productos viables a partir de requerimientos.", referencia:"Bloom (1956)."},
      {verbo:"Dise√±ar Prompts", definicion:"Redactar instrucciones estrat√©gicas para orientar sistemas de IA a metas espec√≠ficas.", referencia:"Anderson & Krathwohl (2001)."}
    ],
    3: [
      {verbo:"Aplicar", definicion:"Trasladar procedimientos a casos conocidos respetando pasos esenciales.", referencia:"Bloom (1956)."},
      {verbo:"Analizar", definicion:"Descomponer informaci√≥n en partes y relaciones para comprender su funcionamiento.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Comparar", definicion:"Identificar semejanzas y diferencias para evaluar alternativas.", referencia:"Bloom (1956)."},
      {verbo:"Organizar", definicion:"Estructurar datos o ideas en categor√≠as coherentes.", referencia:"Krathwohl (2002)."},
      {verbo:"Diferenciar", definicion:"Distinguir lo relevante de lo irrelevante en un contexto dado.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Contrastar", definicion:"Poner a prueba explicaciones frente a evidencias para validar conclusiones.", referencia:"Krathwohl (2002)."},
      {verbo:"Revisar", definicion:"Examinar un producto o proceso para detectar errores y ajustarlos.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Refinar", definicion:"Ajustar una idea para hacerla m√°s precisa o clara.", referencia:"Krathwohl (2002)."}
    ],
    2: [
      {verbo:"Comprender", definicion:"Explicar con palabras propias mostrando conexiones b√°sicas entre ideas.", referencia:"Bloom (1956)."},
      {verbo:"Describir", definicion:"Exponer caracter√≠sticas y atributos sin inferir causas.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Explicar", definicion:"Aclarar el porqu√© de un fen√≥meno con ejemplos simples y nexos causales b√°sicos.", referencia:"Krathwohl (2002)."},
      {verbo:"Interpretar", definicion:"Dar significado a datos o textos en funci√≥n de un contexto.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Ejemplificar", definicion:"Ilustrar un concepto con casos t√≠picos pertinentes.", referencia:"Bloom (1956)."},
      {verbo:"Clasificar", definicion:"Agrupar elementos siguiendo un criterio expl√≠cito y consistente.", referencia:"Krathwohl (2002)."}
    ],
    1: [
      {verbo:"Recordar", definicion:"Evocar hechos, conceptos o f√≥rmulas tal como se aprendieron.", referencia:"Bloom (1956)."},
      {verbo:"Identificar", definicion:"Reconocer un elemento solicitado entre varias opciones.", referencia:"Bloom (1956)."},
      {verbo:"Reconocer", definicion:"Distinguir lo ya visto al ser presentado nuevamente.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Definir", definicion:"Enunciar los rasgos esenciales de un t√©rmino o concepto.", referencia:"Krathwohl (2002)."},
      {verbo:"Listar", definicion:"Enumerar datos o pasos de manera literal sin an√°lisis.", referencia:"Bloom (1956)."},
      {verbo:"Nombrar", definicion:"Mencionar conceptos o t√©rminos a demanda.", referencia:"Bloom (1956)."}
    ]
  },
  HACER: {
    4: [
      {verbo:"Automatizar", definicion:"Transformar procesos en rutinas reproducibles validadas.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Optimizar", definicion:"Reducir tiempos o costos manteniendo calidad mediante ajustes fundamentados.", referencia:"Krathwohl (2002)."},
      {verbo:"Transferir", definicion:"Aplicar destrezas en contextos nuevos adaptando criterios de ejecuci√≥n.", referencia:"Bloom (1956)."},
      {verbo:"Innovar", definicion:"Probar t√©cnicas o herramientas in√©ditas para ejecutar mejor.", referencia:"Krathwohl (2002)."},
      {verbo:"Trazar Estrategias", definicion:"Definir t√°cticas, recursos y m√©tricas para alcanzar un objetivo operativo.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Combinar Herramientas", definicion:"Integrar instrumentos diversos en un flujo de trabajo m√°s eficiente.", referencia:"Bloom (1956)."}
    ],
    3: [
      {verbo:"Coordinar", definicion:"Secuenciar tareas y recursos con autonom√≠a para un resultado eficaz.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Implementar", definicion:"Poner en pr√°ctica un plan respetando especificaciones.", referencia:"Bloom (1956)."},
      {verbo:"Integrar", definicion:"Ensambla componentes o procesos en una unidad funcional.", referencia:"Krathwohl (2002)."},
      {verbo:"Perfeccionar", definicion:"Ajustar la ejecuci√≥n para mejorar precisi√≥n y consistencia.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Aplicar Con Autonom√≠a", definicion:"Ejecutar sin supervisi√≥n constante justificando decisiones t√©cnicas.", referencia:"Krathwohl (2002)."}
    ],
    2: [
      {verbo:"Ejecutar", definicion:"Realizar procedimientos b√°sicos siguiendo un plan dado.", referencia:"Bloom (1956)."},
      {verbo:"Practicar", definicion:"Repetir tareas para ganar fluidez y control.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Demostrar", definicion:"Evidenciar una destreza paso a paso ante otros.", referencia:"Krathwohl (2002)."},
      {verbo:"Operar", definicion:"Manejar equipos o software cumpliendo protocolos.", referencia:"Bloom (1956)."},
      {verbo:"Utilizar Con Apoyo", definicion:"Usar herramientas con gu√≠a puntual cuando es necesario.", referencia:"Anderson & Krathwohl (2001)."}
    ],
    1: [
      {verbo:"Imitar", definicion:"Reproducir una acci√≥n observada con ayuda cercana.", referencia:"Bloom (1956)."},
      {verbo:"Copiar", definicion:"Replicar un modelo o ejemplo sin variaciones propias.", referencia:"Krathwohl (2002)."},
      {verbo:"Seguir Instrucciones", definicion:"Cumplir pasos exactamente como fueron dados.", referencia:"Bloom (1956)."},
      {verbo:"Manipular Con Ayuda", definicion:"Manipular materiales o interfaces bajo supervisi√≥n.", referencia:"Anderson & Krathwohl (2001)."}
    ]
  },
  SER: {
    4: [
      {verbo:"Interiorizar", definicion:"Actuar por convicci√≥n alineando decisiones con valores estables.", referencia:"Krathwohl (2002)."},
      {verbo:"Liderar", definicion:"Guiar a otros hacia metas comunes cuidando el clima √©tico.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Modelar", definicion:"Convertirse en ejemplo visible de la conducta esperada.", referencia:"Bloom (1956)."},
      {verbo:"Transformar", definicion:"Impulsar cambios positivos y sostenibles en la comunidad.", referencia:"Krathwohl (2002)."},
      {verbo:"Influir Positivamente", definicion:"Motivar y persuadir conductas valiosas cuidando el bienestar del otro.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Validar √âticamente", definicion:"Contrastar acciones con principios morales y consecuencias.", referencia:"Krathwohl (2002)."}
    ],
    3: [
      {verbo:"Valorar", definicion:"Emitir juicios sobre pr√°cticas con criterios expl√≠citos.", referencia:"Krathwohl (2002)."},
      {verbo:"Argumentar", definicion:"Sostener posturas respetuosas frente a dilemas con apertura al di√°logo.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Promover", definicion:"Impulsar iniciativas y convocar participaci√≥n.", referencia:"Bloom (1956)."},
      {verbo:"Asumir Responsabilidades", definicion:"Aceptar tareas y responder por sus resultados.", referencia:"Krathwohl (2002)."},
      {verbo:"Ser Consciente", definicion:"Reconocer impactos de los propios actos y regular la conducta.", referencia:"Anderson & Krathwohl (2001)."}
    ],
    2: [
      {verbo:"Responder", definicion:"Actuar adecuadamente ante normas o solicitudes.", referencia:"Bloom (1956)."},
      {verbo:"Participar", definicion:"Involucrarse de manera activa en actividades grupales.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Colaborar", definicion:"Trabajar con otros aportando y escuchando.", referencia:"Krathwohl (2002)."},
      {verbo:"Respetar", definicion:"Cumplir normas y reconocer la dignidad del otro.", referencia:"Bloom (1956)."},
      {verbo:"Cumplir", definicion:"Entregar compromisos y tareas seg√∫n lo pactado.", referencia:"Anderson & Krathwohl (2001)."}
    ],
    1: [
      {verbo:"Atender", definicion:"Prestar atenci√≥n inicial a una tarea o instrucci√≥n.", referencia:"Bloom (1956)."},
      {verbo:"Escuchar", definicion:"Escuchar activamente sin interrumpir.", referencia:"Anderson & Krathwohl (2001)."},
      {verbo:"Aceptar", definicion:"Mostrar apertura a la retroalimentaci√≥n y a nuevas ideas.", referencia:"Krathwohl (2002)."},
      {verbo:"Mostrar Disposici√≥n", definicion:"Ofrecerse a participar con actitud positiva.", referencia:"Bloom (1956)."}
    ]
  }
};


// ================== VERBOS TRANSVERSALES (Notas Pedag√≥gicas) ==================
const VERBOS_TRANSVERSALES = {
  "ARGUMENTAR": {
    SABER: {
      nivel: 4,
      definicion: "Construir un razonamiento cr√≠tico utilizando premisas, contraejemplos y evidencia cient√≠fica.",
      referencia: "Anderson, L. W., & Krathwohl, D. R. (2001). *A taxonomy for learning, teaching, and assessing: A revision of Bloom's taxonomy of educational objectives*. Longman.",
      ejemplo: "Argumenta con evidencia cient√≠fica por qu√© el cambio clim√°tico es un problema global."
    },
    SER: {
      nivel: 3,
      definicion: "Sostener posturas respetuosas frente a dilemas en interacci√≥n social, con apertura al di√°logo.",
      referencia: "Krathwohl, D. R., Bloom, B. S., & Masia, B. B. (1964). *Taxonomy of educational objectives: The classification of educational goals. Handbook II: Affective domain*. David McKay.",
      ejemplo: "Argumenta por qu√© es importante respetar la opini√≥n de los dem√°s en un debate."
    },
    nota: "El verbo *Argumentar* cambia de nivel seg√∫n la dimensi√≥n: en Saber implica razonamiento cr√≠tico (Nivel 4), en Ser implica di√°logo √©tico y social (Nivel 3)."
  },

  "INNOVAR": {
    SABER: {
      nivel: 4,
      definicion: "Proponer ideas o enfoques in√©ditos que integren conocimientos conceptuales.",
      referencia: "Bloom, B. S. (1956). *Taxonomy of educational objectives: Handbook I: Cognitive domain*. Longman.",
      ejemplo: "Innovar un modelo te√≥rico que explique un fen√≥meno social."
    },
    HACER: {
      nivel: 4,
      definicion: "Aplicar t√©cnicas, herramientas o procedimientos novedosos en contextos pr√°cticos.",
      referencia: "Anderson & Krathwohl (2001).",
      ejemplo: "Innovar el uso de software para optimizar un proceso escolar."
    },
    nota: "En Saber la innovaci√≥n es cognitiva (ideas, teor√≠as). En Hacer es pr√°ctica (t√©cnicas, aplicaciones)."
  },

  "CREAR": {
    SABER: {
      nivel: 4,
      definicion: "Producir un modelo, teor√≠a o propuesta conceptual original integrando saberes previos.",
      referencia: "Anderson & Krathwohl (2001).",
      ejemplo: "Crear una hip√≥tesis que explique la relaci√≥n entre dos variables."
    },
    HACER: {
      nivel: 4,
      definicion: "Construir o elaborar un producto, prototipo o material tangible que refleje una idea.",
      referencia: "Krathwohl, D. R. (2002). A revision of Bloom‚Äôs taxonomy: An overview. *Theory into Practice*, 41(4), 212‚Äì218.",
      ejemplo: "Crear un prototipo de aplicaci√≥n educativa para m√≥viles."
    },
    nota: "En Saber crear es un acto cognitivo (modelos, teor√≠as). En Hacer es t√©cnico-material (prototipos, productos)."
  },

  "DISE√ëAR": {
    SABER: {
      nivel: 4,
      definicion: "Planear soluciones conceptuales originales considerando restricciones y variables clave.",
      referencia: "Anderson & Krathwohl (2001).",
      ejemplo: "Dise√±ar un plan de investigaci√≥n educativa."
    },
    HACER: {
      nivel: 4,
      definicion: "Elaborar un plan operativo o un producto funcional aplicando t√©cnicas espec√≠ficas.",
      referencia: "Krathwohl (2002).",
      ejemplo: "Dise√±ar un experimento pr√°ctico en el laboratorio."
    },
    nota: "En Saber dise√±ar es concebir conceptualmente. En Hacer es ejecutar un dise√±o t√©cnico-operativo."
  },

  "JUSTIFICAR": {
    SABER: {
      nivel: 4,
      definicion: "Defender una decisi√≥n con base en datos, razones y an√°lisis cr√≠tico.",
      referencia: "Krathwohl (2002).",
      ejemplo: "Justificar la elecci√≥n de una metodolog√≠a de investigaci√≥n."
    },
    SER: {
      nivel: 3,
      definicion: "Sustentar √©ticamente una conducta o postura, mostrando responsabilidad moral.",
      referencia: "Krathwohl et al. (1964).",
      ejemplo: "Justificar por qu√© se actu√≥ de manera honesta en una situaci√≥n dif√≠cil."
    },
    nota: "En Saber justificar es l√≥gico-cr√≠tico. En Ser es √©tico-actitudinal."
  },

  "EVALUAR": {
    SABER: {
      nivel: 4,
      definicion: "Emitir juicios fundamentados basados en criterios expl√≠citos y evidencia.",
      referencia: "Anderson & Krathwohl (2001).",
      ejemplo: "Evaluar la validez de un argumento cient√≠fico."
    },
    SER: {
      nivel: 3,
      definicion: "Emitir juicios de valor frente a pr√°cticas sociales o conductas desde un marco √©tico.",
      referencia: "Krathwohl et al. (1964).",
      ejemplo: "Evaluar la importancia de la solidaridad en un grupo de trabajo."
    },
    nota: "En Saber evaluar es juicio l√≥gico basado en criterios. En Ser es juicio √©tico y actitudinal."
  },

  "VALORAR": {
    SABER: {
      nivel: 3,
      definicion: "Reconocer la importancia de un conocimiento o fen√≥meno en un marco conceptual.",
      referencia: "Bloom (1956).",
      ejemplo: "Valorar el papel de la biodiversidad en los ecosistemas."
    },
    SER: {
      nivel: 3,
      definicion: "Emitir juicios √©ticos sobre normas, pr√°cticas o conductas, interiorizando valores.",
      referencia: "Krathwohl et al. (1964).",
      ejemplo: "Valorar la honestidad como principio en la vida comunitaria."
    },
    nota: "En Saber valorar significa reconocer la importancia de un concepto. En Ser significa interiorizar un valor √©tico."
  }
};

// ================= HELPER PARA INFO DE VERBOS =================
function getVerboInfo(verbo, dim = null) {
  verbo = verbo.trim().toUpperCase();

  // Primero buscar en VERBOS_INFO (definiciones est√°ndar)
  for (let dimension in VERBOS_INFO) {
    for (let nivel in VERBOS_INFO[dimension]) {
      for (let item of VERBOS_INFO[dimension][nivel]) {
        if (item.verbo.toUpperCase() === verbo) {
          return {
            dimension,
            nivel: parseInt(nivel),
            definicion: item.definicion,
            referencia: item.referencia
          };
        }
      }
    }
  }

  // Luego buscar en VERBOS_TRANSVERSALES si aplica
  if (VERBOS_TRANSVERSALES[verbo]) {
    if (dim && VERBOS_TRANSVERSALES[verbo][dim]) {
      return {
        dimension: dim,
        nivel: VERBOS_TRANSVERSALES[verbo][dim].nivel,
        definicion: VERBOS_TRANSVERSALES[verbo][dim].definicion,
        referencia: VERBOS_TRANSVERSALES[verbo][dim].referencia,
        nota: VERBOS_TRANSVERSALES[verbo].nota,
        ejemplo: VERBOS_TRANSVERSALES[verbo][dim].ejemplo
      };
    }
  }

  return null;
}



// ================= MOSTRAR INFORME =================
function mostrarInforme() {
  const idx = document.getElementById("docenteSelect").value;
  if (idx === "") return;
  docenteActual = docentes[idx];

  const promedio = (
    docentes.reduce((a, b) => a + parseFloat(b.puntaje || 0), 0) /
    docentes.length
  ).toFixed(1);

  const resultadosDim = {
    SABER: { aciertos: 0, total: 0, detalle: [] },
    HACER: { aciertos: 0, total: 0, detalle: [] },
    SER: { aciertos: 0, total: 0, detalle: [] }
  };

  let correctos = [], erroresGraves = [];

  for (let i = 0; i < nombresVerbos.length; i++) {
    const verbo = nombresVerbos[i];
    const colIdx = indicesVerbos[i];
    let valorCrudo = docenteActual.respuestas[colIdx];
    let respuesta = null;
    if (valorCrudo !== undefined && valorCrudo !== null) {
      let limpio = valorCrudo.toString().trim().replace(/[^0-9]/g, "");
      respuesta = limpio ? parseInt(limpio) : null;
    }
    const correcto = nivelesCorrectos[verbo];

    // Detectar dimensi√≥n
    let dim = null;
    for (let d in DATA) {
      for (let nivel in DATA[d]) {
        if (DATA[d][nivel].map(v => v.toUpperCase()).includes(verbo)) {
          dim = d.toUpperCase();
        }
      }
    }

    resultadosDim[dim].total++;
    if (respuesta === correcto) {
      resultadosDim[dim].aciertos++;
      correctos.push({ verbo, dim, correcto });
      resultadosDim[dim].detalle.push(`‚úÖ ${verbo} (Nivel ${correcto})`);
    } else if (respuesta !== null) {
      erroresGraves.push({
        verbo, dim, correcto, respuesta,
        dist: Math.abs(respuesta - correcto)
      });
      resultadosDim[dim].detalle.push(
        `‚ùå ${verbo} (marc√≥ Nivel ${respuesta}, correcto Nivel ${correcto})`
      );
    } else {
      resultadosDim[dim].detalle.push(
        `‚ö†Ô∏è ${verbo} (sin respuesta, correcto Nivel ${correcto})`
      );
    }
  }

  erroresGraves.sort((a, b) => b.dist - a.dist);

  // ====== Construcci√≥n del HTML ======
  let html = `<h3>Informe de ${docenteActual.nombre} ${docenteActual.apellidos}</h3>
  <p><b>Correo:</b> ${docenteActual.correo} | <b>Tel:</b> ${docenteActual.telefono}</p>
  <p><b>Puntaje:</b> ${docenteActual.puntaje} / 70 (Promedio grupal: ${promedio})</p>`;

  // Tabla por dimensi√≥n
  html += `<h4>üìä Resultados por dimensi√≥n</h4><ul>`;
  for (let d in resultadosDim) {
    const r = resultadosDim[d];
    const pct = r.total ? ((r.aciertos / r.total) * 100).toFixed(1) : 0;
    html += `<li><b>${d}:</b> ${r.aciertos}/${r.total} ‚Üí ${pct}%</li>`;
  }
  html += `</ul>`;

  // Top aciertos
  html += `<h4>‚úÖ Principales aciertos</h4><ul>`;
  correctos.slice(0, 10).forEach(c => {
    const info = getVerboInfo(c.verbo);
    if (info) {
      html += `<li><b>${c.verbo}</b> [${c.dim}] (Nivel ${c.correcto})<br>
               <i>${info.definicion}</i><br>
               <small>${info.referencia}</small></li>`;
    } else {
      html += `<li>${c.verbo} [${c.dim}] (Nivel ${c.correcto})</li>`;
    }
  });
  html += `</ul>`;

  // Top errores graves
  html += `<h4>‚ùå Errores m√°s graves</h4><ul>`;
  erroresGraves.slice(0, 10).forEach(e => {
    const info = getVerboInfo(e.verbo);
    if (info) {
      html += `<li><b>${e.verbo}</b> [${e.dim}] ‚Üí marc√≥ Nivel ${e.respuesta}, correcto Nivel ${e.correcto} (distancia ${e.dist})<br>
               <i>${info.definicion}</i><br>
               <small>${info.referencia}</small></li>`;
    } else {
      html += `<li>${e.verbo} [${e.dim}] ‚Üí marc√≥ Nivel ${e.respuesta}, correcto Nivel ${e.correcto} (distancia ${e.dist})</li>`;
    }
  });
  html += `</ul>`;

  // üìã Detalle completo
  html += `<h4>üìã Detalle completo por dimensi√≥n</h4>`;
  for (let d in resultadosDim) {
    html += `<h5>${d}</h5><ul>`;
    resultadosDim[d].detalle.forEach(v => {
      const icono = v.trim().charAt(0); // ‚úÖ, ‚ùå o ‚ö†Ô∏è

      // Capturar el verbo completo (1 o varias palabras)
      const verboMatch = v.replace(/(‚úÖ|‚ùå|‚ö†Ô∏è)\s*/, "").match(/^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±\s]+/);
      const verbo = verboMatch ? verboMatch[0].trim() : "";

      const info = getVerboInfo(verbo);

      // Clase de color
      let clase = "";
      if (icono === "‚úÖ") clase = "verbo-ok";
      if (icono === "‚ùå") clase = "verbo-error";
      if (icono === "‚ö†Ô∏è") clase = "verbo-alerta";

      // Colorear y poner en negrita todo el verbo
      const vColoreado = v.replace(
        verbo,
        `<span class="${clase}"><b>${verbo}</b></span>`
      );

      if (info) {
        html += `<li>${vColoreado}<br><i>${info.definicion}</i><br>
                 <small>${info.referencia}</small></li>`;
      } else {
        html += `<li>${vColoreado}</li>`;
      }
    });
    html += `</ul>`;
  }

  // Lectura pedag√≥gica
  html += `<h4>üìå Lectura pedag√≥gica</h4>
  <p>El docente muestra mayor solidez en <b>SABER</b>, mientras que en <b>HACER</b> y <b>SER</b> aparecen m√°s errores,
  especialmente en niveles avanzados. Se recomienda reforzar progresivamente: primero los verbos b√°sicos,
  luego los de autonom√≠a, y finalmente los de innovaci√≥n y liderazgo.</p>`;

  document.getElementById("informeDocente").innerHTML = html;

  // Gr√°fico comparativo
  const ctx = document.getElementById("chartComparativo").getContext("2d");
  if (chartComparativo) chartComparativo.destroy();
  chartComparativo = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Aciertos", "Errores"],
      datasets: [
        {
          label: "Docente",
          data: [correctos.length, erroresGraves.length],
          backgroundColor: ["#22c55e", "#ef4444"]
        },
        {
          label: "Promedio Grupo",
          data: [
            (promedio / 70) * nombresVerbos.length,
            nombresVerbos.length - (promedio / 70) * nombresVerbos.length
          ],
          backgroundColor: ["#93c5fd", "#fca5a5"]
        }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } }
  });
}


// ------------------ EXPORTACIONES ------------------
function exportarExcel() {
  const ws = XLSX.utils.json_to_sheet(resumenExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Summary Report");
  XLSX.writeFile(wb, "Summary_Report.xlsx");
}

function exportarExcelDocente() {
  if (!docenteActual) return;
  const data = [
    {Categoria: "Correo", Valor: docenteActual.correo},
    {Categoria: "Tel√©fono", Valor: docenteActual.telefono},
    {Categoria: "Puntaje", Valor: docenteActual.puntaje}
  ];
  data.push({Categoria: "‚úÖ Verbos Correctos", Valor: correctosGlobal.length});
  correctosGlobal.forEach(v => data.push({Categoria: "Correcto", Valor: v}));
  data.push({Categoria: "‚ùå Verbos Errados", Valor: erradosGlobal.length});
  erradosGlobal.forEach(v => data.push({Categoria: "Errado", Valor: v}));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Informe Docente");
  XLSX.writeFile(wb, `Informe_${docenteActual.nombre}_${docenteActual.apellidos}.xlsx`);
}

function exportarExcelTodos() {
  if (!docentes.length) return;
  const wb = XLSX.utils.book_new();

  docentes.forEach((d, i) => {
    let correctos = [];
    let errados = [];

    nombresVerbos.forEach((v, j) => {
      const respuesta = parseInt(d.respuestas[indicesVerbos[j]]);
      const correcto = nivelesCorrectos[v];
      if (respuesta === correcto) {
        correctos.push(`${v} (Nivel ${correcto})`);
      } else {
        errados.push(`${v} (marc√≥ Nivel ${respuesta}, correcto Nivel ${correcto})`);
      }
    });

    const data = [
      {Categoria: "Correo", Valor: d.correo},
      {Categoria: "Tel√©fono", Valor: d.telefono},
      {Categoria: "Puntaje", Valor: d.puntaje},
      {Categoria: "‚úÖ Verbos Correctos", Valor: correctos.length}
    ];
    correctos.forEach(v => data.push({Categoria: "Correcto", Valor: v}));
    data.push({Categoria: "‚ùå Verbos Errados", Valor: errados.length});
    errados.forEach(v => data.push({Categoria: "Errado", Valor: v}));

    const ws = XLSX.utils.json_to_sheet(data);

    // üìå Nombre con inicial may√∫scula
    let nombreCompleto = toTitleCase(d.nombre + " " + d.apellidos);
    let nombreHoja = nombreCompleto.substring(0, 25);

    // Evitar duplicados
    let contador = 1;
    while (wb.SheetNames.includes(nombreHoja)) {
      nombreHoja = nombreCompleto.substring(0, 20) + "_" + contador;
      contador++;
    }

    XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
  });

  XLSX.writeFile(wb, "Consolidado_Docentes.xlsx");
}



</script>

</body>
</html>
